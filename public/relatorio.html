<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relat√≥rio Era K | MindKappa</title>
  <link rel="stylesheet" href="assets/style.css" />

  <!-- Chart.js & PDF -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    .report-container { text-align:center; padding:20px; }
    .report-content {
      background: rgba(255,255,255,0.95);
      padding:30px; border-radius:18px;
      box-shadow:0 10px 35px rgba(0,0,0,0.15);
      text-align:left; margin-top:20px;
    }
    .user-header {
      background:linear-gradient(135deg,#1e3a8a,#3730a3);
      color:#fff; padding:22px; border-radius:15px;
      box-shadow:0 10px 30px rgba(30,58,138,.35);
      margin-bottom:25px;
    }
    .hero-line {font-size:1.1rem;color:#475569;margin-bottom:20px;}
    .premium-cta {
      background:linear-gradient(135deg,#312e81,#7c3aed);
      color:#fff; padding:25px; border-radius:15px;
      text-align:center; margin:30px 0;
      box-shadow:0 10px 30px rgba(49,46,129,.3);
    }
    .loading-spinner{
      width:70px;height:70px;border:6px solid #e2e8f0;
      border-top:6px solid #6366f1;border-radius:50%;
      margin:40px auto;animation:spin 1s linear infinite;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    canvas {max-width:300px;margin:20px auto;display:block;}
  </style>
</head>

<body>
<div class="container">
  <div class="card">
    <header style="text-align:center;padding-top:20px;">
      <div style="font-size:2rem;">üß†</div>
      <div style="font-size:1.6rem;font-weight:700;color:#1e40af;">MindKappa | Era K</div>
      <div style="color:#6b7280;font-size:.9rem;">Relat√≥rio de Coer√™ncia Decisional</div>
    </header>

    <div class="report-container">
      <div id="reportContent">
        <div class="loading-spinner"></div>
        <p style="color:#4b5563;">Gerando seu relat√≥rio Era K...</p>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://mindkappa-backend.onrender.com';
const el = {reportContent: document.getElementById('reportContent')};

window.addEventListener('load', initReport);

async function initReport(){
  const userData = JSON.parse(localStorage.getItem('mindkappa_user'));
  if(!userData){window.location.href='index.html';return;}
  const params = new URLSearchParams(window.location.search);
  const approved = params.get('collection_status')==='approved'||params.get('status')==='approved';
  approved ? await generatePremium(userData) : showFree(userData);
}

/* ---------- Relat√≥rio Gratuito UAU ---------- */
function showFree(userData){
  const {kappa,R,theta}=computeKappa(userData);
  const interp=interpretK(kappa);

  el.reportContent.innerHTML=`
    <div class="user-header">
      <div style="font-size:1.3rem;">${userData.name||'Explorador'}</div>
      <div style="opacity:.9;">Relat√≥rio UAU ‚Ä¢ ${new Date().toLocaleDateString()}</div>
    </div>

    <div class="report-content">
      <h2 style="color:#1e40af;margin-top:0;">üåÄ Seu K = ${kappa.toFixed(3)}</h2>
      <p class="hero-line">${interp.texto}</p>

      <canvas id="kappaChart"></canvas>

      <p style="margin-top:20px;">
        <strong>Como o K √© calculado:</strong><br>
        A coer√™ncia (Œ∫) representa o alinhamento entre suas decis√µes ‚Äî o comprimento
        do vetor resultante R em uma circunfer√™ncia de inten√ß√µes. Quanto maior R, mais
        consistente √© o padr√£o; quanto menor, mais criativo e oscilante.
      </p>
      <div style="background:#eef2ff;padding:15px;border-radius:10px;margin-top:20px;">
        <em>‚ÄúO K √© a assinatura invis√≠vel da coer√™ncia. Cada mente tra√ßa seu pr√≥prio
        c√≠rculo entre caos e forma.‚Äù</em>
      </div>

      <div class="premium-cta">
        <h3>üíé Desbloqueie o Relat√≥rio Completo Era K</h3>
        <p style="opacity:.9;">An√°lise expandida + PDF + gr√°ficos de coer√™ncia</p>
        <button class="btn" onclick="buyPremium()"
          style="background:#10b981;max-width:320px;margin-top:10px;">Gerar Relat√≥rio Premium R$ 9,90</button>
      </div>

      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="btn" onclick="window.location.href='index.html'"
          style="background:#e2e8f0;color:#374151;">üè† In√≠cio</button>
        <button class="btn" onclick="newAnalysis()">üîÑ Nova An√°lise</button>
      </div>
    </div>`;
  drawChart(R,theta);
}

function computeKappa(userData){
  const all=userData.teste1?.decisions.concat(userData.teste2?.decisions||[],userData.teste3?.decisions||[])||[];
  const thetas=all.filter(d=>d.choice!=='timeout').map(d=>d.choice==='azul'?0:Math.PI);
  const N=thetas.length;
  const sumCos=thetas.reduce((s,t)=>s+Math.cos(t),0);
  const sumSin=thetas.reduce((s,t)=>s+Math.sin(t),0);
  const Rlen=Math.sqrt(sumCos**2+sumSin**2)/N||0;
  const kappa=Rlen<0.999?(Rlen*(2-Rlen**2))/(1-Rlen**2):10;
  const theta=Math.atan2(sumSin,sumCos);
  return {kappa,R:Rlen,theta};
}

function interpretK(k){
  if(k<0.2) return {texto:'Seu K indica um campo de escolhas aleat√≥rias ‚Äî uma mente em pura explora√ß√£o.'};
  if(k<0.5) return {texto:'Seu K revela uma coer√™ncia oscilante ‚Äî a criatividade vive no equil√≠brio entre foco e fluidez.'};
  if(k<0.8) return {texto:'Seu K mostra alinhamento est√°vel ‚Äî decis√µes coerentes com o centro da inten√ß√£o.'};
  return {texto:'Seu K √© elevado ‚Äî coer√™ncia extrema, quase cristalina. Cuidado para n√£o se tornar r√≠gido.'};
}

function drawChart(R,theta){
  const ctx=document.getElementById('kappaChart').getContext('2d');
  const x=R*Math.cos(theta),y=R*Math.sin(theta);
  new Chart(ctx,{
    type:'scatter',
    data:{
      datasets:[
        {label:'Vetor R',data:[{x,y}],backgroundColor:'#6366f1'},
        {label:'Circunfer√™ncia',data:circlePoints(),showLine:true,borderColor:'#d1d5db',pointRadius:0}
      ]
    },
    options:{
      scales:{x:{min:-1,max:1},y:{min:-1,max:1}},
      plugins:{legend:{display:false}},aspectRatio:1
    }
  });
}
function circlePoints(){
  const pts=[];for(let a=0;a<=2*Math.PI;a+=0.1){pts.push({x:Math.cos(a),y:Math.sin(a)});}
  return pts;
}

/* ---------- Relat√≥rio Premium ---------- */
async function buyPremium(){
  try{
    const res=await fetch(`${API_URL}/api/simple-subscription`,{method:'POST',headers:{'Content-Type':'application/json'}});
    const data=await res.json();
    if(data.success&&data.payment_link) window.location.href=data.payment_link;
    else alert('Pagamento indispon√≠vel.');
  }catch(e){alert('Erro ao iniciar pagamento.');}
}

async function generatePremium(userData){
  el.reportContent.innerHTML=`<div class="loading-spinner"></div><p>Gerando relat√≥rio premium...</p>`;
  try{
    const res=await fetch(`${API_URL}/api/generate-premium-report`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userData})
    });
    if(!res.ok)throw new Error('Erro');
    const data=await res.json();
    showPremium(data.relatorio,userData);
  }catch(e){
    el.reportContent.innerHTML='<p style="color:#ef4444;">Erro ao gerar relat√≥rio premium.</p>';
  }
}

function showPremium(text,userData){
  el.reportContent.innerHTML=`
  <div class="user-header">
    <div style="font-size:1.3rem;">${userData.name||'Explorador'}</div>
    <div style="opacity:.9;">Relat√≥rio Premium ‚Ä¢ ${new Date().toLocaleDateString()}</div>
  </div>
  <div class="report-content">
    <pre style="white-space:pre-line;color:#1e293b;">${text}</pre>
    <button class="btn" onclick="downloadPDF()" style="background:#10b981;">üìÑ Baixar PDF Premium</button>
  </div>`;
}

/* ---------- PDF ---------- */
async function downloadPDF(){
  const {jsPDF}=window.jspdf;const pdf=new jsPDF();
  const content=document.querySelector('.report-content');
  const canvas=await html2canvas(content);const img=canvas.toDataURL('image/png');
  pdf.addImage(img,'PNG',10,10,190,0);
  pdf.save('Relatorio_EraK.pdf');
}

/* ---------- Utilidades ---------- */
function newAnalysis(){
  if(confirm('Reiniciar?')){localStorage.clear();window.location.href='index.html';}
}
</script>
</body>
</html>
