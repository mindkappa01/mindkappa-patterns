<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seu Relat√≥rio MindKappa | Resultados</title>
    <link rel="stylesheet" href="assets/style.css">
    <style>
        .report-container { text-align: center; padding: 20px; }
        .loading-spinner { 
            width: 60px; height: 60px; border: 6px solid #e2e8f0; 
            border-top: 6px solid #63b3ed; border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 30px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .report-content { text-align: left; background: white; padding: 30px; border-radius: 15px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .premium-cta { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; padding: 25px; border-radius: 15px; margin: 30px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .feature-list { text-align: left; margin: 20px 0; }
        .feature-item { margin: 12px 0; padding-left: 25px; position: relative; font-size: 1rem; }
        .feature-item:before { content: "‚úì"; position: absolute; left: 0; color: #48bb78; font-weight: bold; }
        .insight-item { background: rgba(99, 179, 237, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #63b3ed; }
        .user-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; }
        
        .btn { 
            background: linear-gradient(45deg, #63b3ed, #4299e1);
            color: white; border: none; padding: 15px 30px; 
            font-size: 1.1rem; font-weight: 600; border-radius: 50px; 
            cursor: pointer; transition: all 0.3s ease; width: 100%; 
            margin-top: 10px; 
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99, 179, 237, 0.4); }
        
        .fallback-message { 
            background: #fff3cd; border: 1px solid #ffeaa7; 
            padding: 20px; border-radius: 10px; margin: 20px 0;
            color: #856404;
        }

        .kappa-badge {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white; padding: 8px 15px; border-radius: 20px;
            font-size: 0.9rem; font-weight: bold; display: inline-block;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="report-container">
                <div class="logo">üìä</div>
                <div class="title">Seu Relat√≥rio MindKappa</div>
                <div class="subtitle">An√°lise cient√≠fica baseada em 45 decis√µes</div>
                
                <div id="reportContent">
                    <!-- Conte√∫do din√¢mico -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const elements = {
            reportContent: document.getElementById('reportContent')
        };

        // ‚úÖ BACKEND ATUALIZADO - USANDO RENDER
        const MINDKAPPA_BACKEND = 'https://mindkappa-backend.onrender.com';

        function initializeReport() {
            const userData = JSON.parse(localStorage.getItem('mindkappa_user'));
            
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }

            showGenerateButton(userData);
        }

        function showGenerateButton(userData) {
            elements.reportContent.innerHTML = `
                <div class="user-header">
                    <div style="font-size: 1.3rem; margin-bottom: 5px;">${userData.name || 'Explorador'}</div>
                    <div style="opacity: 0.9;">${userData.age || ''} anos ‚Ä¢ ${userData.emotion || 'Curioso'}</div>
                </div>
                
                <div style="margin: 30px 0;">
                    <div style="color: #4a5568; margin-bottom: 25px; line-height: 1.6;">
                        <strong>3 testes completos ‚Ä¢ 45 decis√µes analisadas</strong><br>
                        <span style="color: #718096; font-size: 0.95rem;">
                            ‚ö° Instinto Puro ‚Ä¢ ‚öñÔ∏è Equil√≠brio Mental ‚Ä¢ ‚è∞ Press√£o Temporal
                        </span>
                    </div>
                    <button class="btn" onclick="generateReport()" style="font-size: 1.2rem; padding: 18px 40px;">
                        üß† Gerar Meu Relat√≥rio com IA
                    </button>
                    <div style="color: #718096; font-size: 0.9rem; margin-top: 15px;">
                        An√°lise profunda dos seus padr√µes √∫nicos com MCD Core
                    </div>
                </div>
            `;
        }

        async function generateReport() {
            elements.reportContent.innerHTML = `
                <div style="margin: 40px 0;">
                    <div class="loading-spinner"></div>
                    <div style="color: #4a5568; margin-top: 20px;">
                        Analisando seus padr√µes com IA avan√ßada...
                    </div>
                    <div style="color: #718096; font-size: 0.9rem; margin-top: 10px;">
                        Processando 45 decis√µes ‚Ä¢ Gerando insights exclusivos
                    </div>
                </div>
            `;

            try {
                const userData = JSON.parse(localStorage.getItem('mindkappa_user'));
                
                // ‚úÖ SALVAR DADOS NO BACKEND ATUAL
                try {
                    await saveResearchData(userData);
                } catch (error) {
                    console.log('‚ö†Ô∏è Dados n√£o salvos:', error);
                }
                
                // ‚úÖ GERAR RELAT√ìRIO COM BACKEND ATUAL
                const gptResponse = await callGPT4API(userData);
                showFinalReport(gptResponse, userData);
            } catch (error) {
                console.error('Erro:', error);
                showErrorState();
            }
        }

        // ‚úÖ ATUALIZADO: Salvar dados no backend Render
        async function saveResearchData(userData) {
            try {
                const response = await fetch(`${MINDKAPPA_BACKEND}/api/save-research-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userData: userData,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    console.log('‚úÖ Dados salvos para pesquisa');
                }
            } catch (error) {
                console.log('üì° Dados n√£o salvos (sem conex√£o):', error);
            }
        }

        // ‚úÖ ATUALIZADO: Chamar API do Render
        async function callGPT4API(userData) {
            console.log('üîó Iniciando chamada API...');
            console.log('üåê Backend:', MINDKAPPA_BACKEND);
            
            try {
                const response = await fetch(`${MINDKAPPA_BACKEND}/api/generate-report`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userData })
                });
                
                console.log('üì° Status da resposta:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Dados recebidos:', data);
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Erro na API:', error);
                
                // ‚úÖ FALLBACK: Gerar relat√≥rio local com dados MCD Core
                return generateEnhancedFallbackReport(userData);
            }
        }

        // ‚úÖ NOVO: Relat√≥rio fallback melhorado com dados MCD Core
        function generateEnhancedFallbackReport(userData) {
            const analysis = analyzeAllTests(userData);
            
            return {
                relatorio: `
üß† Seu Relat√≥rio MindKappa - An√°lise Cient√≠fica

üìä RESUMO DOS SEUS TESTES:

${analysis.teste1.kappa ? `‚ö° INSTINTO PURO:
   ‚Ä¢ Coer√™ncia: ${analysis.teste1.kappaLevel} (Œ∫ = ${analysis.teste1.kappa})
   ‚Ä¢ Padr√£o: ${analysis.teste1.pattern}
   ‚Ä¢ ${analysis.teste1.blueCount} azuis ‚Ä¢ ${analysis.teste1.redCount} vermelhos` : '‚ö° Dados em an√°lise'}

${analysis.teste2.kappa ? `‚öñÔ∏è EQUIL√çBRIO MENTAL:
   ‚Ä¢ Coer√™ncia: ${analysis.teste2.kappaLevel} (Œ∫ = ${analysis.teste2.kappa})  
   ‚Ä¢ Balanceamento: ${analysis.teste2.balance}
   ‚Ä¢ ${analysis.teste2.blueCount} azuis ‚Ä¢ ${analysis.teste2.redCount} vermelhos` : '‚öñÔ∏è Dados em an√°lise'}

${analysis.teste3.kappa ? `‚è∞ PRESS√ÉO TEMPORAL:
   ‚Ä¢ Coer√™ncia: ${analysis.teste3.kappaLevel} (Œ∫ = ${analysis.teste3.kappa})
   ‚Ä¢ Performance: ${analysis.teste3.performance}
   ‚Ä¢ Timeouts: ${analysis.teste3.timeouts}/15` : '‚è∞ Dados em an√°lise'}

üí° AN√ÅLISE CIENT√çFICA:
Seus padr√µes de decis√£o revelam caracter√≠sticas √∫nicas de coer√™ncia.

üéØ PR√ìXIMOS PASSOS:
Para uma an√°lise mais profunda com IA generativa, tente novamente em alguns minutos.
                `,
                source: 'fallback_enhanced'
            };
        }

        // ‚úÖ NOVO: An√°lise completa com dados MCD Core
        function analyzeAllTests(userData) {
            const analysis = {
                teste1: analyzeTestWithKappa(userData.teste1, 'Instinto'),
                teste2: analyzeTestWithKappa(userData.teste2, 'Equil√≠brio'),
                teste3: analyzeTestWithKappa(userData.teste3, 'Press√£o')
            };
            
            return analysis;
        }

        function analyzeTestWithKappa(testeData, testType) {
            if (!testeData || !testeData.decisions) {
                return { pattern: 'Dados em an√°lise' };
            }
            
            // Calcular Œ∫ localmente (fallback)
            const choices = testeData.decisions
                .filter(d => d.choice !== 'timeout')
                .map(d => d.choice === 'azul' ? 'Azul' : 'Vermelho');
            
            if (choices.length === 0) {
                return { pattern: 'Sem dados v√°lidos' };
            }
            
            const kappaResult = calculateLocalKappa(choices);
            const blueCount = choices.filter(c => c === 'Azul').length;
            const redCount = choices.filter(c => c === 'Vermelho').length;
            
            let pattern = "Equilibrado";
            if (blueCount > redCount * 1.3) pattern = "Prefer√™ncia por Azul";
            else if (redCount > blueCount * 1.3) pattern = "Prefer√™ncia por Vermelho";
            
            let performance = "Consistente";
            if (testType === 'Press√£o') {
                const timeouts = testeData.decisions.filter(d => d.timedOut).length;
                performance = timeouts < 5 ? "Resistente" : "Sens√≠vel √† press√£o";
            }
            
            let balance = "Moderado";
            if (testType === 'Equil√≠brio') {
                const diff = Math.abs(blueCount - redCount);
                balance = diff <= 3 ? "Excelente" : diff <= 6 ? "Bom" : "Prefer√™ncias definidas";
            }
            
            return {
                kappa: kappaResult.kappa.toFixed(3),
                kappaLevel: kappaResult.level,
                pattern: pattern,
                performance: performance,
                balance: balance,
                blueCount: blueCount,
                redCount: redCount,
                timeouts: testeData.decisions ? testeData.decisions.filter(d => d.timedOut).length : 0
            };
        }

        // ‚úÖ Fun√ß√£o para c√°lculo Œ∫ local (fallback)
        function calculateLocalKappa(choices) {
            const thetas = choices.map(c => c === 'Azul' ? 0 : Math.PI);
            const N = thetas.length;
            
            const sumCos = thetas.reduce((s, t) => s + Math.cos(t), 0);
            const sumSin = thetas.reduce((s, t) => s + Math.sin(t), 0);
            
            const R = Math.sqrt(sumCos**2 + sumSin**2) / N;
            
            let kappa = 0;
            if (R > 0.001 && R < 0.999) {
                kappa = (R * (2 - R**2)) / (1 - R**2);
            } else if (R >= 0.999) {
                kappa = 10;
            }
            
            let level = "BAIXA";
            if (kappa >= 1.0) level = "ALTA";
            else if (kappa >= 0.5) level = "MODERADA";
            
            return { kappa: Math.min(kappa, 10), level: level };
        }

        function showFinalReport(gptResponse, userData) {
            elements.reportContent.innerHTML = `
                <div class="user-header">
                    <div style="font-size: 1.3rem; margin-bottom: 5px;">${userData.name || 'Explorador'}</div>
                    <div style="opacity: 0.9;">Relat√≥rio Personalizado ‚Ä¢ ${new Date().toLocaleDateString()}</div>
                </div>

                <div class="report-content">
                    <div style="color: #4a5568; line-height: 1.7; white-space: pre-line;">
                        ${gptResponse.relatorio}
                    </div>
                    
                    ${gptResponse.source === 'fallback_enhanced' ? `
                        <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 10px; border-left: 4px solid #63b3ed;">
                            <strong>üìä An√°lise Cient√≠fica MindKappa</strong><br>
                            <small>Relat√≥rio gerado com c√°lculo Œ∫ local - Para an√°lise completa com IA, tente novamente.</small>
                        </div>
                    ` : ''}
                </div>

                <!-- CTA PARA KAPITTY -->
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; margin: 30px 0; text-align: center;">
                    <h3 style="margin: 0 0 10px 0;">üöÄ CONTINUE SUA JORNADA NO KAPITTY</h3>
                    <p style="margin: 0 0 15px 0; opacity: 0.9;">+20 exerc√≠cios imersivos ‚Ä¢ Trilha sonora ‚Ä¢ Labirintos de escolha</p>
                    
                    <a href="https://kapitty.fit" 
                       style="background: white; color: #2d3748; border: none; padding: 15px 30px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; font-weight: bold; transition: all 0.3s; text-decoration: none; display: inline-block;">
                        üéÆ EXPLORAR KAPITTY.FIT
                    </a>
                    
                    <div style="font-size: 0.8rem; margin-top: 15px; opacity: 0.7;">
                        ‚úÖ Experi√™ncia imersiva ‚Ä¢ Testes especiais ‚Ä¢ Relat√≥rios avan√ßados
                    </div>
                </div>

                <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn" onclick="window.location.href='index.html'" 
                            style="background: #e2e8f0; color: #4a5568; flex: 1;">
                        üè† Voltar ao In√≠cio
                    </button>
                    <button class="btn" onclick="newAnalysis()" 
                            style="background: #63b3ed; color: white; flex: 1;">
                        üîÑ Nova An√°lise
                    </button>
                </div>
            `;
        }

        function showErrorState() {
            elements.reportContent.innerHTML = `
                <div class="fallback-message">
                    <div style="font-size: 1.2rem; margin-bottom: 10px;">üòï Sistema em Atualiza√ß√£o</div>
                    <div style="margin-bottom: 15px;">
                        Nossa an√°lise com IA est√° passando por melhorias. 
                        Enquanto isso, aqui est√° uma vis√£o dos seus dados:
                    </div>
                    <button class="btn" onclick="showBasicAnalysis()" 
                            style="background: #667eea; color: white;">
                        üìä Ver An√°lise B√°sica
                    </button>
                </div>
            `;
        }

        function showBasicAnalysis() {
            const userData = JSON.parse(localStorage.getItem('mindkappa_user'));
            const fallback = generateEnhancedFallbackReport(userData);
            showFinalReport(fallback, userData);
        }

        function newAnalysis() {
            if (confirm('Isso ir√° reiniciar todo o processo. Tem certeza?')) {
                localStorage.removeItem('mindkappa_user');
                localStorage.removeItem('mindkappa_session');
                window.location.href = 'index.html';
            }
        }

        window.addEventListener('load', initializeReport);
    </script>

    <!-- LGPD Modal -->
    <div id="lgpdModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; font-family: Arial, sans-serif;">
        <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 500px; margin: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h3 style="color: #2c3e50; margin-bottom: 1rem;">üìã Termo de Consentimento</h3>
            
            <p style="margin-bottom: 1rem;"><strong>O MindKappa respeita sua privacidade:</strong></p>
            
            <ul style="margin-bottom: 1rem; padding-left: 1.5rem;">
                <li><strong>Coletamos:</strong> suas escolhas (Azul/Vermelho) e √≠ndice de coer√™ncia (Œ∫)</li>
                <li><strong>N√ÉO coletamos:</strong> dados pessoais, localiza√ß√£o, IP ou informa√ß√µes do dispositivo</li>
                <li><strong>Finalidade:</strong> melhorar nosso produto e pesquisa cient√≠fica agregada</li>
            </ul>

            <p style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">
                Conforme Lei Geral de Prote√ß√£o de Dados (LGPD), voc√™ pode solicitar exclus√£o a qualquer momento.
            </p>

            <button onclick="acceptLGPD()" style="background: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 1rem; width: 100%;">
                ‚úÖ Concordo e quero continuar
            </button>
        </div>
    </div>

    <script>
    function checkLGPD() {
        if (!localStorage.getItem('lgpd_accepted')) {
            document.getElementById('lgpdModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }

    function acceptLGPD() {
        localStorage.setItem('lgpd_accepted', 'true');
        document.getElementById('lgpdModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    window.addEventListener('load', checkLGPD);
    </script>
</body>
</html>