<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seu Relat√≥rio MindKappa | Resultados</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .report-container { text-align: center; padding: 20px; }
    .loading-spinner { width: 60px; height: 60px; border: 6px solid #e2e8f0; border-top: 6px solid #63b3ed; border-radius: 50%; animation: spin 1s linear infinite; margin: 30px auto; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .report-content { text-align: left; background: #fff; padding: 30px; border-radius: 15px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .premium-cta { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 25px; border-radius: 15px; margin: 30px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .feature-list { text-align: left; margin: 20px 0; }
    .feature-item { margin: 12px 0; padding-left: 25px; position: relative; font-size: 1rem; }
    .feature-item:before { content: "‚úì"; position: absolute; left: 0; color: #48bb78; font-weight: bold; }
    .insight-item { background: rgba(99, 179, 237, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #63b3ed; }
    .user-header { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 20px; border-radius: 15px; margin-bottom: 25px; }
    .btn { background: linear-gradient(45deg, #63b3ed, #4299e1); color:#fff; border:none; padding:15px 30px; font-size:1.1rem; font-weight:600; border-radius:50px; cursor:pointer; transition: all .3s; width:100%; margin-top:10px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(99,179,237,0.4); }
    .fallback-message { background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 10px; margin: 20px 0; color: #856404; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- Cabe√ßalho -->
      <header style="text-align:center; padding:20px 0 0 0;">
        <div style="font-size:2rem;">üß†</div>
        <div style="font-size:1.5rem; font-weight:700; color:#1e40af;">MindKappa</div>
        <div style="color:#6b7280; font-size:.9rem; margin-top:5px;">An√°lise de Padr√µes Decisorais</div>
      </header>

      <div class="report-container">
        <div class="logo">üìä</div>
        <div class="title">Seu Relat√≥rio MindKappa</div>
        <div class="subtitle">An√°lise cient√≠fica baseada em 45 decis√µes</div>
        <div id="reportContent"><!-- din√¢mico --></div>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG BACKEND =========
    const API_URL =
      (window.env && window.env.API_URL) ||
      (typeof importMeta !== 'undefined' && importMeta.env && importMeta.env.VITE_API_URL) ||
      'http://localhost:3000';

    const elements = {
      reportContent: document.getElementById('reportContent')
    };

    function initializeReport() {
      const userData = JSON.parse(localStorage.getItem('mindkappa_user'));
      if (!userData) { window.location.href = 'index.html'; return; }

      // Se voltou do Checkout aprovado -> gera premium automaticamente
      const params = new URLSearchParams(window.location.search);
      const approved =
        params.get('collection_status') === 'approved' ||
        params.get('status') === 'approved';
      if (approved) {
        generatePremiumReport(); // gera premium direto
        return;
      }

      showGenerateButton(userData);
    }

    function showGenerateButton(userData) {
      elements.reportContent.innerHTML = `
        <div class="user-header">
          <div style="font-size:1.3rem; margin-bottom:5px;">${userData.name || 'Explorador'}</div>
          <div style="opacity:.9;">Relat√≥rio Personalizado ‚Ä¢ ${new Date().toLocaleDateString()}</div>
        </div>

        <div style="margin:30px 0;">
          <div style="color:#4a5568; margin-bottom:25px; line-height:1.6;">
            <strong>3 testes completos ‚Ä¢ 45 decis√µes analisadas</strong><br/>
            <span style="color:#718096; font-size:.95rem;">‚ö° Instinto Puro ‚Ä¢ ‚öñÔ∏è Equil√≠brio Mental ‚Ä¢ ‚è∞ Press√£o Temporal</span>
          </div>

          <button class="btn" onclick="generateReport()" style="font-size:1.2rem; padding:18px 40px;">
            üß† Gerar Meu Relat√≥rio com IA (Gr√°tis)
          </button>

          <div class="premium-cta">
            <h3 style="margin:0 0 10px 0;">üöÄ DESBLOQUEIE SUA AN√ÅLISE COMPLETA</h3>
            <p style="margin:0 0 15px 0; opacity:.9;">Relat√≥rio Premium com IA Generativa + PDF para download imediato</p>
            <button onclick="buyPremiumReport()"
  style="background: linear-gradient(135deg, #10b981, #059669); color:#fff; border:none; padding:18px 40px; font-size:1.1rem; border-radius:50px; cursor:pointer; font-weight:700; transition: all .3s; width:100%; max-width:320px; box-shadow:0 8px 25px rgba(16,185,129,.3);">
  üíé Pagar e Gerar Relat√≥rio Premium
</button>
            <div class="feature-list">
              <div class="feature-item">An√°lise aprofundada dos seus 3 testes</div>
              <div class="feature-item">PDF para download e compartilhamento</div>
              <div class="feature-item">Compara√ß√£o com base populacional</div>
              <div class="feature-item">Recomenda√ß√µes pr√°ticas personalizadas</div>
            </div>
          </div>
        </div>

        <div style="margin-top:25px; display:flex; gap:10px; justify-content:center;">
          <button class="btn" onclick="window.location.href='index.html'"
            style="background:#e2e8f0; color:#4a5568; flex:1;">üè† Voltar ao In√≠cio</button>
          <button class="btn" onclick="newAnalysis()" style="background:#63b3ed; color:#fff; flex:1;">üîÑ Nova An√°lise</button>
        </div>
      `;
    }

    // ===== Relat√≥rio Gr√°tis =====
    async function generateReport() {
      elements.reportContent.innerHTML = `
        <div style="margin:40px 0;">
          <div class="loading-spinner"></div>
          <div style="color:#4a5568; margin-top:20px;">Calculando coer√™ncia e analisando padr√µes...</div>
          <div style="color:#718096; font-size:.9rem; margin-top:10px;">Processando 45 decis√µes ‚Ä¢ Gerando insights exclusivos</div>
        </div>
      `;

      try {
        const userData = JSON.parse(localStorage.getItem('mindkappa_user'));
        const sessionId = localStorage.getItem('mindkappa_session');

        // Atualizar coer√™ncia
        const updateResponse = await fetch(`${API_URL}/api/update-user-coherence`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ userData, sessionId })
        });
        if (!updateResponse.ok) throw new Error('Erro ao calcular coer√™ncia');
        const updateData = await updateResponse.json();
        const userDataComCoerencia = updateData.updatedUserData;
        localStorage.setItem('mindkappa_user', JSON.stringify(userDataComCoerencia));

        // Gerar relat√≥rio gr√°tis
        const response = await fetch(`${API_URL}/api/generate-report`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ userData: userDataComCoerencia })
        });
        if (!response.ok) throw new Error('Erro no relat√≥rio gr√°tis');
        const gptResponse = await response.json();

        showFinalReport(gptResponse, userDataComCoerencia);

      } catch (error) {
        console.error('Erro:', error);
        showErrorState();
      }
    }

    function showFinalReport(gptResponse, userData) {
      elements.reportContent.innerHTML = `
        <div class="user-header">
          <div style="font-size:1.3rem; margin-bottom:5px;">${userData.name || 'Explorador'}</div>
          <div style="opacity:.9;">Relat√≥rio Personalizado ‚Ä¢ ${new Date().toLocaleDateString()}</div>
        </div>

        <div class="report-content">
          <div style="color:#4a5568; line-height:1.7; white-space:pre-line;">
            ${gptResponse.relatorio}
          </div>

          ${gptResponse.source === 'fallback_enhanced' ? `
            <div style="margin-top:20px; padding:15px; background:#f0f9ff; border-radius:10px; border-left:4px solid #63b3ed;">
              <strong>üìä An√°lise Cient√≠fica MindKappa</strong><br/>
              <small>Relat√≥rio gerado em modo b√°sico. Para an√°lise completa com IA, use a vers√£o Premium.</small>
            </div>
          ` : ''}

          <div class="premium-cta">
            <h3 style="margin:0 0 10px 0;">üöÄ DESBLOQUEIE SUA AN√ÅLISE COMPLETA</h3>
            <p style="margin:0 0 15px 0; opacity:.9;">Relat√≥rio Premium com IA Generativa + PDF para download imediato</p>
            <button onclick="startPremiumFlow()"
              style="background: linear-gradient(135deg, #10b981, #059669); color:#fff; border:none; padding:18px 40px; font-size:1.1rem; border-radius:50px; cursor:pointer; font-weight:700; transition: all .3s; width:100%; max-width:320px; box-shadow:0 8px 25px rgba(16,185,129,.3);">
              üíé Pagar e Gerar Relat√≥rio Premium
            </button>
          </div>
        </div>

        <div style="margin-top:25px; display:flex; gap:10px; justify-content:center;">
          <button class="btn" onclick="window.location.href='index.html'"
            style="background:#e2e8f0; color:#4a5568; flex:1;">üè† Voltar ao In√≠cio</button>
          <button class="btn" onclick="newAnalysis()" style="background:#63b3ed; color:#fff; flex:1;">üîÑ Nova An√°lise</button>
        </div>
      `;
    }

    function showErrorState() {
      elements.reportContent.innerHTML = `
        <div class="fallback-message">
          <div style="font-size:1.2rem; margin-bottom:10px;">üòï Sistema em atualiza√ß√£o</div>
          <div style="margin-bottom:15px;">
            Nossa an√°lise com IA est√° passando por melhorias. Enquanto isso, voc√™ pode ver a vers√£o b√°sica:
          </div>
          <button class="btn" onclick="showBasicAnalysis()" style="background:#667eea; color:#fff;">üìä Ver An√°lise B√°sica</button>
        </div>
      `;
    }

    // ====== Fallback local (mesmo do seu c√≥digo, simplificado) ======
    function showBasicAnalysis() {
      const userData = JSON.parse(localStorage.getItem('mindkappa_user'));
      const fallback = generateEnhancedFallbackReport(userData);
      showFinalReport(fallback, userData);
    }

    function generateEnhancedFallbackReport(userData) {
      const analysis = analyzeAllTests(userData);
      return {
        relatorio: `
üß† Seu Relat√≥rio MindKappa - An√°lise Cient√≠fica

üìä RESUMO DOS SEUS TESTES:

${analysis.teste1.kappa ? `‚ö° INSTINTO: Œ∫ ${analysis.teste1.kappa} (${analysis.teste1.kappaLevel}) ‚Ä¢ ${analysis.teste1.blueCount} azuis ‚Ä¢ ${analysis.teste1.redCount} vermelhos` : '‚ö° Dados em an√°lise'}
${analysis.teste2.kappa ? `‚öñÔ∏è EQUIL√çBRIO: Œ∫ ${analysis.teste2.kappa} (${analysis.teste2.kappaLevel}) ‚Ä¢ ${analysis.teste2.blueCount} azuis ‚Ä¢ ${analysis.teste2.redCount} vermelhos` : '‚öñÔ∏è Dados em an√°lise'}
${analysis.teste3.kappa ? `‚è∞ PRESS√ÉO: Œ∫ ${analysis.teste3.kappa} (${analysis.teste3.kappaLevel}) ‚Ä¢ Timeouts ${analysis.teste3.timeouts}/15` : '‚è∞ Dados em an√°lise'}

üí° An√°lise: seus padr√µes revelam caracter√≠sticas √∫nicas de coer√™ncia.
üéØ Para an√°lise completa com IA generativa, ative a vers√£o Premium.
        `,
        source: 'fallback_enhanced'
      };
    }

    function analyzeAllTests(userData) {
      return {
        teste1: analyzeTestWithKappa(userData.teste1, 'Instinto'),
        teste2: analyzeTestWithKappa(userData.teste2, 'Equil√≠brio'),
        teste3: analyzeTestWithKappa(userData.teste3, 'Press√£o')
      };
    }

    function analyzeTestWithKappa(testeData, testType) {
      if (!testeData || !testeData.decisions) return { pattern: 'Dados em an√°lise' };
      const choices = testeData.decisions.filter(d => d.choice !== 'timeout').map(d => d.choice === 'azul' ? 'Azul' : 'Vermelho');
      if (!choices.length) return { pattern: 'Sem dados v√°lidos' };
      const k = calculateLocalKappa(choices);
      const blueCount = choices.filter(c => c === 'Azul').length;
      const redCount  = choices.filter(c => c === 'Vermelho').length;
      return {
        kappa: k.kappa.toFixed(3),
        kappaLevel: k.level,
        blueCount, redCount,
        timeouts: testeData.decisions.filter(d => d.timedOut).length || 0
      };
    }

    function calculateLocalKappa(choices) {
      const thetas = choices.map(c => c === 'Azul' ? 0 : Math.PI);
      const N = thetas.length;
      const sumCos = thetas.reduce((s, t) => s + Math.cos(t), 0);
      const sumSin = thetas.reduce((s, t) => s + Math.sin(t), 0);
      const R = Math.sqrt(sumCos**2 + sumSin**2) / N;
      let kappa = 0;
      if (R > 0.001 && R < 0.999) kappa = (R * (2 - R**2)) / (1 - R**2);
      else if (R >= 0.999) kappa = 10;
      let level = "BAIXA";
      if (kappa >= 1.0) level = "ALTA";
      else if (kappa >= 0.5) level = "MODERADA";
      return { kappa: Math.min(kappa, 10), level };
    }

    function newAnalysis() {
      if (confirm('Isso ir√° reiniciar todo o processo. Tem certeza?')) {
        localStorage.removeItem('mindkappa_user');
        localStorage.removeItem('mindkappa_session');
        window.location.href = 'index.html';
      }
    }

    // ===== Fluxo Premium (Pagamento ‚ûú Volta ‚ûú Gera) =====
    async function startPremiumFlow() {
      try {
        console.log('üîÑ Iniciando pagamento (Checkout Pro)‚Ä¶');
        const res = await fetch(`${API_URL}/api/simple-subscription`, { method:'POST', headers:{'Content-Type':'application/json'} });
        const data = await res.json();
        if (data.success && data.payment_link) {
          window.location.href = data.payment_link; // redireciona pro Mercado Pago
        } else {
          throw new Error('Link de pagamento n√£o gerado');
        }
      } catch (e) {
        console.error('‚ùå Erro no pagamento:', e);
        alert('‚ö†Ô∏è Sistema de pagamento em manuten√ß√£o. Tente novamente em alguns minutos.');
      }
    }

    async function generatePremiumReport() {
      try {
        console.log('üíé Gerando relat√≥rio premium‚Ä¶');
        const userData = JSON.parse(localStorage.getItem('mindkappa_user'));
        const sessionId = localStorage.getItem('mindkappa_session');

        // Loading
        elements.reportContent.innerHTML = `
          <div style="margin:40px 0;">
            <div class="loading-spinner"></div>
            <div style="color:#4a5568; margin-top:20px;">Gerando sua an√°lise premium‚Ä¶</div>
            <div style="color:#718096; font-size:.9rem; margin-top:10px;">Processamento avan√ßado com IA ‚Ä¢ Insights exclusivos</div>
          </div>
        `;

        // Atualiza coer√™ncia (garante consist√™ncia)
        const updateResponse = await fetch(`${API_URL}/api/update-user-coherence`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ userData, sessionId })
        });
        if (!updateResponse.ok) throw new Error('Erro ao calcular coer√™ncia');
        const updateData = await updateResponse.json();
        const userDataComCoerencia = updateData.updatedUserData;
        localStorage.setItem('mindkappa_user', JSON.stringify(userDataComCoerencia));

        // Gera Premium
        const premiumResponse = await fetch(`${API_URL}/api/generate-premium-report`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ userData: userDataComCoerencia, sessionId })
        });
        if (!premiumResponse.ok) throw new Error('Erro no relat√≥rio premium');
        const premiumData = await premiumResponse.json();
        showPremiumReport(premiumData.relatorio, userDataComCoerencia);

      } catch (e) {
        console.error('‚ùå Erro no premium:', e);
        alert('‚ö†Ô∏è Servi√ßo premium indispon√≠vel no momento. Tente novamente mais tarde.');
      }
    }

    function showPremiumReport(relatorio, userData) {
      elements.reportContent.innerHTML = `
        <div class="user-header">
          <div style="font-size:1.3rem; margin-bottom:5px;">${userData.name || 'Explorador'}</div>
          <div style="opacity:.9;">Relat√≥rio Premium ‚Ä¢ ${new Date().toLocaleDateString()}</div>
        </div>

        <div class="report-content">
          <div style="color:#4a5568; line-height:1.7; white-space:pre-line;">${relatorio}</div>
        </div>

        <div style="margin:30px 0; text-align:center;">
          <button class="btn" onclick="downloadPDF()" style="background: linear-gradient(135deg, #10b981, #059669);">
            üìÑ Download PDF Premium
          </button>
          <div style="color:#718096; font-size:.9rem; margin-top:10px;">Salve seu relat√≥rio completo para consulta futura</div>
        </div>

        <div style="margin-top:25px; display:flex; gap:10px; justify-content:center;">
          <button class="btn" onclick="window.location.href='index.html'" style="background:#e2e8f0; color:#4a5568; flex:1;">üè† Voltar ao In√≠cio</button>
          <button class="btn" onclick="newAnalysis()" style="background:#63b3ed; color:#fff; flex:1;">üîÑ Nova An√°lise</button>
        </div>
      `;
    }

    // ===== PDF Premium =====
    async function downloadPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const userData = JSON.parse(localStorage.getItem('mindkappa_user'));
        const userName = (userData?.name || 'Explorador').toString();

        const t1 = userData?.teste1 || {};
        const t2 = userData?.teste2 || {};
        const t3 = userData?.teste3 || {};

        const k1 = Number(t1?.coherence?.kappa || 0);
        const k2 = Number(t2?.coherence?.kappa || 0);
        const k3 = Number(t3?.coherence?.kappa || 0);

        const az1 = t1?.statistics?.blueCount || 0, vr1 = t1?.statistics?.redCount || 0;
        const az2 = t2?.statistics?.blueCount || 0, vr2 = t2?.statistics?.redCount || 0;
        const az3 = t3?.statistics?.blueCount || 0, vr3 = t3?.statistics?.redCount || 0;

        // CAPA
        doc.setFillColor(30,64,175);
        doc.rect(0,0,210,297,'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(32); doc.text('üß†', 105, 60, {align:'center'});
        doc.setFontSize(24); doc.text('RELAT√ìRIO PREMIUM', 105, 80, {align:'center'});
        doc.setFontSize(18); doc.text('MindKappa MCD', 105, 100, {align:'center'});
        doc.setFontSize(16); doc.text(userName, 105, 120, {align:'center'});
        doc.setFontSize(12); doc.text('An√°lise Avan√ßada de Padr√µes Decisorais', 105, 135, {align:'center'});
        doc.text(`Gerado em: ${new Date().toLocaleDateString()}`, 105, 150, {align:'center'});

        // P√°gina 1
        doc.addPage();
        doc.setTextColor(30,64,175); doc.setFontSize(20);
        doc.text('üìä SEU MAPA DECISIONAL COMPLETO', 20, 30);
        doc.setDrawColor(30,64,175); doc.line(20, 35, 190, 35);
        doc.setTextColor(0,0,0); doc.setFontSize(12);
        const intro = `Ol√°, ${userName}!\n\nEste relat√≥rio premium revela insights profundos sobre seus padr√µes √∫nicos de tomada de decis√£o, baseado em 45 escolhas analisadas pelo algoritmo MCD.`;
        doc.text(doc.splitTextToSize(intro, 170), 20, 50);

        // P√°gina 2
        doc.addPage();
        doc.setTextColor(30,64,175); doc.setFontSize(18);
        doc.text('üéØ RESULTADOS DOS 3 TESTES', 20, 30);
        doc.line(20, 35, 190, 35);
        doc.setTextColor(0,0,0); doc.setFontSize(12);

        doc.text(`‚ö° Instinto Puro: ${az1} azuis | ${vr1} vermelhos`, 20, 50);
        doc.text(`Œ∫ = ${k1.toFixed(3)} (${t1?.coherence?.level || 'N/A'})`, 20, 60);
        doc.text(`‚öñÔ∏è Equil√≠brio Mental: ${az2} azuis | ${vr2} vermelhos`, 20, 80);
        doc.text(`Œ∫ = ${k2.toFixed(3)} (${t2?.coherence?.level || 'N/A'})`, 20, 90);
        doc.text(`‚è∞ Press√£o Temporal: ${az3} azuis | ${vr3} vermelhos`, 20, 110);
        doc.text(`Œ∫ = ${k3.toFixed(3)} (${t3?.coherence?.level || 'N/A'})`, 20, 120);

        // Gr√°fico barras Œ∫
        doc.setFontSize(14); doc.text('üìà Perfil de Coer√™ncia (Œ∫)', 20, 145);
        const maxK = Math.max(k1, k2, k3, 1);
        doc.setFillColor(99,179,237);
        doc.rect(40, 155, (k1/maxK)*100, 8, 'F'); doc.text('Instinto', 150, 161);
        doc.rect(40, 170, (k2/maxK)*100, 8, 'F'); doc.text('Equil√≠brio', 150, 176);
        doc.rect(40, 185, (k3/maxK)*100, 8, 'F'); doc.text('Press√£o', 150, 191);

        // P√°gina 3
        doc.addPage();
        doc.setTextColor(30,64,175); doc.setFontSize(18);
        doc.text('üí° Exerc√≠cios Personalizados', 20, 30);
        doc.line(20, 35, 190, 35);
        doc.setTextColor(0,0,0); doc.setFontSize(11);
        const tips = [
          'üéØ Observa√ß√£o consciente: em decis√µes di√°rias, pause 5s e observe seu processo mental.',
          'üîÑ Flexibilidade: resolva um problema por 3 caminhos diferentes.',
          '‚ö° Intui√ß√£o vs Raz√£o: simples = intui√ß√£o; complexas = pr√≥s e contras.',
          'üé™ Perspectiva: imagine como outra pessoa resolveria seu desafio.'
        ];
        let y=50;
        tips.forEach(t => { const lines = doc.splitTextToSize(t, 170); doc.text(lines, 20, y); y += lines.length*6 + 8; });

        // Rodap√©
        doc.setFontSize(10); doc.setTextColor(100,100,100);
        const disc = 'üí° Este relat√≥rio √© uma ferramenta de autoconhecimento. N√£o substitui avalia√ß√£o profissional. MindKappa üß†';
        doc.text(doc.splitTextToSize(disc, 170), 20, 270);

        doc.save(`Relatorio_Premium_MindKappa_${userName.replace(/\s+/g,'_')}.pdf`);
        console.log('‚úÖ PDF premium gerado');
      } catch (err) {
        console.error('‚ùå Erro ao gerar PDF:', err);
        alert('üìÑ Erro ao gerar PDF. Tente novamente.');
      }
    }

    // ===== LGPD =====
    function checkLGPD() {
      if (!localStorage.getItem('lgpd_accepted_v1')) {
        document.getElementById('lgpdModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }
    function acceptLGPD() {
      localStorage.setItem('lgpd_accepted_v1', 'true');
      document.getElementById('lgpdModal').style.display = 'none';
      document.body.style.overflow = '';
    }

    window.addEventListener('load', () => { checkLGPD(); initializeReport(); });
  </script>

  <script>
async function buyPremiumReport() {
  try {
    const res = await fetch(`${API_URL}/api/simple-subscription`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if (data.success && data.payment_link) {
      window.location.href = data.payment_link;
    } else {
      throw new Error('Link de pagamento n√£o gerado');
    }
  } catch (err) {
    console.error('Pagamento erro:', err);
    alert('‚ö†Ô∏è Pagamento indispon√≠vel no momento. Tente novamente.');
  }
}
</script>

  <!-- LGPD Modal -->
  <div id="lgpdModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:10000; justify-content:center; align-items:center; font-family:Arial,sans-serif;">
    <div style="background:#fff; padding:2rem; border-radius:15px; max-width:520px; margin:1rem; box-shadow:0 10px 30px rgba(0,0,0,.3);">
      <h3 style="color:#1e40af; margin-bottom:.8rem;">üìã Termo de Consentimento</h3>
      <p style="margin-bottom:.8rem;"><strong>Respeitamos sua privacidade:</strong></p>
      <ul style="margin-bottom:1rem; padding-left:1.5rem; color:#374151;">
        <li><strong>Coletamos:</strong> escolhas (AZUL/VERMELHO) e m√©tricas do teste.</li>
        <li><strong>N√£o coletamos:</strong> dados sens√≠veis.</li>
        <li><strong>Finalidade:</strong> gerar seu relat√≥rio e melhorar o MindKappa.</li>
      </ul>
      <button onclick="acceptLGPD()" style="background:#111827; color:#fff; border:none; padding:12px 30px; border-radius:8px; cursor:pointer; font-size:1rem; width:100%;">‚úÖ Concordo e continuar</button>
    </div>
  </div>
</body>
</html>
