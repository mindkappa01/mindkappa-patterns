<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teste 2 - Equil√≠brio Mental | MindKappa</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .test-container { text-align: center; padding: 20px; }
    .progress-info { margin-bottom: 30px; color: #4a5568; }
    .progress-bar-container { width: 100%; height: 8px; background: #e2e8f0; border-radius: 10px; margin: 20px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(45deg, #63b3ed, #4299e1); border-radius: 10px; transition: width .3s ease; width:0%; }
    .buttons-container { display: flex; gap: 20px; justify-content: center; margin: 40px 0; flex-wrap: wrap; }
    .choice-btn { width: 150px; height: 150px; border: none; border-radius: 20px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: all .2s ease; box-shadow: 0 8px 20px rgba(0,0,0,.15); }
    .choice-btn:active { transform: scale(0.95); }
    .btn-azul { background: linear-gradient(135deg, #63b3ed, #4299e1); color: #fff; }
    .btn-vermelho { background: linear-gradient(135deg, #fc8181, #f56565); color: #fff; }
    .decision-count { font-size: 1.1rem; color: #718096; margin-bottom: 10px; }
    .completion-message { font-size: 1.3rem; color: #2d3748; margin: 30px 0; }
    .loading { opacity: 0.7; pointer-events: none; }
    .instruction-highlight { background: rgba(99,179,237,.1); padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #63b3ed; }
    .balance-preview { background: rgba(102,126,234,.1); padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #667eea; }
    .btn-next {
      background: #111827; color: #fff; border: none; padding: 14px 20px; border-radius: 10px;
      cursor: pointer; font-weight: 700; box-shadow: 0 8px 20px rgba(0,0,0,.15);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header style="text-align:center; padding: 20px 0 0 0;">
        <div style="font-size: 2rem;">üß†</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;">MindKappa</div>
        <div style="color: #6b7280; font-size: .9rem; margin-top: 5px;">An√°lise de Padr√µes Decisorais</div>
      </header>

      <div class="test-container">
        <div class="logo">‚öñÔ∏è</div>
        <div class="title">Equil√≠brio Mental</div>

        <div class="instruction-highlight">
          <div class="subtitle">Busque um equil√≠brio natural entre AZUL e VERMELHO</div>
        </div>

        <div class="progress-info">
          <div class="decision-count">Decis√£o: <span id="currentDecision">0</span>/20</div>
          <div class="progress-bar-container">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <div id="contentArea">
          <div class="buttons-container" id="buttonsContainer"><!-- Bot√µes via JS --></div>
          <div style="color:#718096; font-size:.9rem; margin-top: 30px;">Encontre seu pr√≥prio ritmo de balanceamento</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const TEST_CONFIG = { totalDecisions: 20, decisionDelay: 150, minReactionTime: 50 };
    const API_URL = (window.env && window.env.API_URL) ||
                    (typeof importMeta !== 'undefined' && importMeta.env && importMeta.env.VITE_API_URL) ||
                    'window.location.origin';

    // ===== Estado =====
    let testState = {
      currentDecision: 0,
      decisions: [],
      testStartedAt: null, // in√≠cio do teste (para dura√ß√£o)
      lastTickAt: null,    // para reaction time
      counts: { azul: 0, vermelho: 0 },
      switchPattern: [],
      sessionId: null
    };

    const elements = {
      buttonsContainer: document.getElementById('buttonsContainer'),
      currentDecision: document.getElementById('currentDecision'),
      progressFill: document.getElementById('progressFill'),
      contentArea: document.getElementById('contentArea')
    };

    // ===== Init =====
    function initializeTest() {
      console.log('üß† Iniciando Teste 2 - Equil√≠brio Mental');

      let sessionId = localStorage.getItem('mindkappa_session');
      if (!sessionId) {
        sessionId = 'mk-' + Date.now() + '-' + Math.random().toString(36).slice(2,10);
        localStorage.setItem('mindkappa_session', sessionId);
      }
      testState.sessionId = sessionId;

      testState.testStartedAt = Date.now();
      showNextDecision(true);
    }

    // ===== L√≥gica =====
    function showNextDecision(isFirst=false) {
      if (!isFirst) testState.currentDecision++;
      if (isFirst) testState.currentDecision = 1;

      if (testState.currentDecision > TEST_CONFIG.totalDecisions) {
        completeTest();
        return;
      }
      updateProgressUI();
      renderDecisionButtons();
      testState.lastTickAt = Date.now();
    }

    function updateProgressUI() {
      elements.currentDecision.textContent = testState.currentDecision;
      const progressPercent = (testState.currentDecision - 1) / TEST_CONFIG.totalDecisions * 100;
      elements.progressFill.style.width = `${Math.max(progressPercent,0)}%`;
    }

    function renderDecisionButtons() {
      const positions = getRandomizedPositions();
      elements.buttonsContainer.innerHTML = `
        <button class="choice-btn btn-azul" onclick="handleDecision('azul', ${positions.azulPosition})" aria-label="Escolher Azul">AZUL</button>
        <button class="choice-btn btn-vermelho" onclick="handleDecision('vermelho', ${positions.vermelhoPosition})" aria-label="Escolher Vermelho">VERMELHO</button>
      `;
      elements.buttonsContainer.style.flexDirection = positions.direction;
    }

    function getRandomizedPositions() {
      const useNormalLayout = Math.random() > 0.5;
      const azulFirst = Math.random() > 0.5;
      if (useNormalLayout) {
        return { direction:'row', azulPosition: azulFirst ? 0 : 1, vermelhoPosition: azulFirst ? 1 : 0 };
      }
      return { direction:'row-reverse', azulPosition: azulFirst ? 1 : 0, vermelhoPosition: azulFirst ? 0 : 1 };
    }

    function handleDecision(choice, buttonPosition) {
      const now = Date.now();
      const reactionTime = now - (testState.lastTickAt || now);
      if (reactionTime < TEST_CONFIG.minReactionTime) return;

      // contadores
      testState.counts[choice]++;

      // altern√¢ncia (equil√≠brio consciente)
      if (testState.decisions.length > 0) {
        const lastChoice = testState.decisions[testState.decisions.length - 1].choice;
        testState.switchPattern.push(lastChoice !== choice);
      }

      testState.decisions.push({
        choice,
        timestamp: new Date().toISOString(),
        reactionTime,
        decisionNumber: testState.currentDecision,
        buttonPosition,
        cumulativeBalance: Math.abs(testState.counts.azul - testState.counts.vermelho)
      });

      elements.buttonsContainer.classList.add('loading');
      setTimeout(() => {
        elements.buttonsContainer.classList.remove('loading');
        showNextDecision();
      }, TEST_CONFIG.decisionDelay);
    }

    // ===== Backend MCD =====
    async function calcularKappaBackend(choices, testType, sessionId) {
      const url = `${API_URL}/api/calculate-coherence`;
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ choices, testType, sessionId })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'Erro no c√°lculo');
      return data;
    }

    // ===== M√©tricas auxiliares de equil√≠brio (client) =====
    function calculateQuickBalanceScore() {
      const maxDeviation = TEST_CONFIG.totalDecisions;
      const actualDeviation = Math.abs(testState.counts.azul - testState.counts.vermelho);
      return Math.round((1 - (actualDeviation / maxDeviation)) * 100);
    }

    function detectQuickStrategy() {
      const deviation = Math.abs(testState.counts.azul - testState.counts.vermelho);
      const switchCount = testState.switchPattern.filter(Boolean).length;
      if (deviation <= 3 && switchCount > 5) return "equilibrio_consciente";
      if (deviation <= 6) return "equilibrio_moderado";
      return "preferencia_definida";
    }

    // ===== Conclus√£o =====
    async function completeTest() {
      const totalDurationMs = Date.now() - testState.testStartedAt;

      // salva decis√µes brutas/local
      let userData = JSON.parse(localStorage.getItem('mindkappa_user') || '{}');
      userData.teste2 = {
        decisions: testState.decisions,
        completedAt: new Date().toISOString(),
        durationMs: totalDurationMs,
        finalCounts: { ...testState.counts }
      };
      localStorage.setItem('mindkappa_user', JSON.stringify(userData));

      try {
        console.log('üì° Enviando escolhas ao backend para calcular Œ∫‚Ä¶');
        const choices = testState.decisions.map(d => d.choice === 'azul' ? 'Azul' : 'Vermelho');
        const resultado = await calcularKappaBackend(choices, 'equilibrio', testState.sessionId);

        // persist√™ncia coherence + statistics
        userData = JSON.parse(localStorage.getItem('mindkappa_user') || '{}');
        userData.teste2 = {
          ...userData.teste2,
          coherence: resultado.coherence,
          statistics: resultado.statistics
        };
        localStorage.setItem('mindkappa_user', JSON.stringify(userData));

        const { kappa, level, description, emoji, color } = resultado.coherence;

        // notas auxiliares (client)
        const balanceScore = calculateQuickBalanceScore();
        detectQuickStrategy(); // (mantido se quiser usar depois)

        let performanceNote = "";
        if (kappa < 0.3) performanceNote = "üéØ Excelente equil√≠brio!";
        else if (kappa < 0.6) performanceNote = "‚öñÔ∏è Bom senso de equil√≠brio!";
        else performanceNote = "üîç Padr√£o interessante!";

        elements.contentArea.innerHTML = `
          <div class="completion-message">‚úÖ Teste de Equil√≠brio Conclu√≠do!</div>
          <div class="balance-preview" style="background:${color}15; border-left:4px solid ${color};">
            <div style="font-size: 24px; margin-bottom: 6px;">${emoji}</div>
            <strong>${performanceNote}</strong><br/>
            <strong>Coer√™ncia ${level}:</strong> ${description}<br/>
            <strong>Œ∫ = ${Number(kappa).toFixed(3)}</strong> ‚Ä¢
            ${resultado.statistics.blueCount} azuis ‚Ä¢ ${resultado.statistics.redCount} vermelhos<br/>
            <small>Score de equil√≠brio (aprox.): ${balanceScore}%</small>
          </div>
          <div style="color:#718096; margin-bottom: 24px;">Seu padr√£o de equil√≠brio foi analisado com sucesso.</div>
          <button class="btn-next" onclick="proximoTeste()">‚û°Ô∏è Ir para o Teste 3</button>
        `;
        elements.progressFill.style.width = '100%';

      } catch (err) {
        console.error('‚ùå Erro no c√°lculo MCD:', err);

        // fallback local
        const balanceScore = calculateQuickBalanceScore();
        let performanceNote = balanceScore > 80 ? "üéØ Excelente equil√≠brio!"
                          : balanceScore > 60 ? "‚öñÔ∏è Bom senso de equil√≠brio!"
                          : "üîç Padr√£o interessante!";

        elements.contentArea.innerHTML = `
          <div class="completion-message">‚úÖ Teste de Equil√≠brio Conclu√≠do!</div>
          <div class="balance-preview">
            <strong>Seu Resultado:</strong> ${performanceNote}<br/>
            <small>${testState.counts.azul} azuis ‚Ä¢ ${testState.counts.vermelho} vermelhos</small><br/>
            <small>Score de equil√≠brio (aprox.): ${balanceScore}%</small>
          </div>
          <div style="color:#718096; margin-bottom: 24px;">Seu padr√£o de balanceamento foi mapeado.</div>
          <button class="btn-next" onclick="proximoTeste()">‚û°Ô∏è Ir para o Teste 3</button>
        `;
        elements.progressFill.style.width = '100%';
      }
    }

    function proximoTeste() {
      window.location.href = 'teste3.html';
    }

    // ===== Boot =====
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeTest);
    } else {
      initializeTest();
    }
  </script>

  <!-- LGPD (s√≥ aparece se ainda n√£o aceitou) -->
  <div id="lgpdModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:10000; justify-content:center; align-items:center; font-family:Arial,sans-serif;">
    <div style="background:#fff; padding:2rem; border-radius:15px; max-width:520px; margin:1rem; box-shadow:0 10px 30px rgba(0,0,0,.3);">
      <h3 style="color:#1e40af; margin-bottom: .8rem;">üìã Termo de Consentimento</h3>
      <p style="margin-bottom:.8rem;"><strong>Respeitamos sua privacidade:</strong></p>
      <ul style="margin-bottom:1rem; padding-left:1.5rem; color:#374151;">
        <li><strong>Coletamos:</strong> escolhas (AZUL/VERMELHO) e m√©tricas do teste.</li>
        <li><strong>N√£o coletamos:</strong> dados sens√≠veis.</li>
        <li><strong>Finalidade:</strong> gerar seu relat√≥rio e melhorar o MindKappa.</li>
      </ul>
      <button onclick="acceptLGPD()" style="background:#111827; color:#fff; border:none; padding:12px 30px; border-radius:8px; cursor:pointer; font-size:1rem; width:100%;">‚úÖ Concordo e continuar</button>
    </div>
  </div>

  <script>
    function checkLGPD() {
      if (!localStorage.getItem('lgpd_accepted_v1')) {
        document.getElementById('lgpdModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }
    function acceptLGPD() {
      localStorage.setItem('lgpd_accepted_v1', 'true');
      document.getElementById('lgpdModal').style.display = 'none';
      document.body.style.overflow = '';
    }
    document.addEventListener('DOMContentLoaded', checkLGPD);
  </script>
</body>
</html>
