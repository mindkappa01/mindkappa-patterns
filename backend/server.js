const express = require('express');
const cors = require('cors');
const OpenAI = require('openai');
const { Pool } = require('pg');

const app = express();
app.use(cors());
app.use(express.json());

// ==================== üóÑÔ∏è CONEX√ÉO COM BANCO POSTGRESQL ====================
// ‚úÖ VERIFICAR SE A VARI√ÅVEL EXISTE
console.log('üîß Testando com URL correta...');

// ‚úÖ COLE SUA URL CORRETA AQUI (substitua TODO o conte√∫do)
const DATABASE_URL_CORRETA = 'postgresql://postgres:XCZkvTZkbwnJAnqMHWtzcEVcOUIFmYmf@postgres.railway.internal:5432/railway';

const pool = new Pool({
  connectionString: DATABASE_URL_CORRETA,
  ssl: { 
    rejectUnauthorized: false 
  },
  connectionTimeoutMillis: 15000, // 15 segundos
  idleTimeoutMillis: 30000
});

// Teste DETALHADO
console.log('üß™ Iniciando teste de conex√£o...');
console.log('üîó URL:', DATABASE_URL_CORRETA.replace(/:[^:]*@/, ':****@')); // Esconde senha nos logs

pool.query('SELECT NOW() as server_time, version() as pg_version, current_database() as db_name')
  .then(result => {
    const row = result.rows[0];
    console.log('üéâ üéâ üéâ CONEX√ÉO BEM-SUCEDIDA! üéâ üéâ üéâ');
    console.log('‚è∞ Hora do servidor:', row.server_time);
    console.log('üêò PostgreSQL:', row.pg_version.split(',')[0]);
    console.log('üóÑÔ∏è Banco:', row.db_name);
    console.log('‚úÖ BANCO DE DADOS CONECTADO COM SUCESSO!');
  })
  .catch(err => {
    console.error('‚ùå FALHA NA CONEX√ÉO:', err.message);
    console.log('üîß Dicas:');
    console.log('   ‚Ä¢ Verifique se a senha est√° correta');
    console.log('   ‚Ä¢ Verifique se o host/port est√£o corretos');
    console.log('   ‚Ä¢ Verifique se o banco "railway" existe');
  });

// DEBUG DA CONEX√ÉO
console.log('=== üö® DEBUG CONEX√ÉO ===');
console.log('DATABASE_URL exists:', !!process.env.DATABASE_URL);
console.log('NODE_ENV:', process.env.NODE_ENV);

// Teste r√°pido
pool.query('SELECT NOW() as time')
  .then(result => console.log('‚úÖ Teste de conex√£o OK:', result.rows[0].time))
  .catch(err => console.error('‚ùå Teste de conex√£o FALHOU:', err.message));


console.log('üîß Configurando Pool com:', process.env.DATABASE_URL ? 'DATABASE_URL encontrada' : 'DATABASE_URL n√£o encontrada');

// ==================== üîê MERCADO PAGO ====================
const mercadopago = require('mercadopago');

// ‚úÖ CONFIGURA√á√ÉO SUPER SIMPLES (sem try/catch)
mercadopago.configure({
  access_token: 'TEST-4776420197323076-100420-7bc09edb85e7e1e7cb76deb8b546988b-608368877'
});
console.log('‚úÖ Mercado Pago configurado');

// OpenAI config - chave vem das vari√°veis de ambiente
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// Rota de sa√∫de para testar
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    message: 'MindKappa Backend funcionando!',
    timestamp: new Date().toISOString()
  });
});

// Rota principal para gerar relat√≥rios
app.post('/api/generate-report', async (req, res) => {
  try {
    console.log('üì• Recebendo solicita√ß√£o de relat√≥rio...');
    const { userData } = req.body;

    if (!userData) {
      return res.status(400).json({ error: 'Dados do usu√°rio n√£o fornecidos' });
    }

    // Preparar prompt baseado no exemplo que voc√™ me enviou
    const prompt = criarPromptPersonalizado(userData);

    const completion = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [
        {
          role: "system",
          content: `Voc√™ √© um especialista em an√°lise de padr√µes mentais. 

IMPORTANTE: SIGA EXATAMENTE este formato e estilo:

üß† Seu Relat√≥rio Pessoal do MCD
[Nome] - Descobrindo Como Sua Mente Funciona
Data do Teste: [data]
Dura√ß√£o Total: Cerca de [X] minutos
Decis√µes Analisadas: [X] escolhas

üéØ O Que Voc√™ Fez (Resumo Simples)
[Descri√ß√£o dos 3 testes com ‚Ä¢ bullets]

üîç O Que Descobrimos Sobre Voc√™
Seu Perfil Mental: "[T√≠tulo Criativo]"
[Descri√ß√£o do perfil]

Como Sua Mente Funciona:
[‚Ä¢ Pontos com emojis]

üåü O Que Isso Significa Para Voc√™
Pontos Fortes da Sua Mente:
[‚Ä¢ Lista]
Curiosidades Sobre Voc√™:
[‚Ä¢ Lista]

üé≤ Comparando Voc√™ Com Outras Pessoas
[Compara√ß√£o e "Seu Tipo Mental"]

üí° Dicas Para o Seu Dia a Dia
Use Seus Pontos Fortes:
[‚Ä¢ Dicas]
Para Expandir Ainda Mais:
[‚Ä¢ Dicas]

üéâ Mensagem Final
[Mensagem inspiradora]

TOM: Conversacional, motivador, "UAU", sempre positivo, pr√°tico com exemplos da vida real.`
        },
        {
          role: "user",
          content: prompt
        }
      ],
      max_tokens: 1800,
      temperature: 0.7
    });

    console.log('‚úÖ Relat√≥rio gerado com sucesso');
    
    res.json({ 
      success: true,
      relatorio: completion.choices[0].message.content,
      insights: [
        "An√°lise completa dos seus padr√µes mentais",
        "Compara√ß√£o com perfis similares", 
        "Recomenda√ß√µes personalizadas"
      ]
    });

  } catch (error) {
    console.error('‚ùå Erro no backend:', error);
    res.status(500).json({ 
      success: false,
      error: 'Erro ao gerar relat√≥rio: ' + error.message
    });
  }
});

// Fun√ß√£o para criar prompt personalizado
function criarPromptPersonalizado(userData) {
  const teste1 = analisarTeste1(userData.teste1);
  const teste2 = analisarTeste2(userData.teste2);
  const teste3 = analisarTeste3(userData.teste3);

  return `Gere um relat√≥rio NO ESTILO EXATO do exemplo para:

NOME: ${userData.name}
IDADE: ${userData.age}
G√äNERO: ${userData.gender}
EMO√á√ÉO INICIAL: ${userData.emotion}

RESULTADOS DETALHADOS:

TESTE 1 - INSTINTO PURO (50 decis√µes):
‚Ä¢ O que a pessoa fez: ${teste1.resumo}
‚Ä¢ Padr√£o detectado: ${teste1.padrao}
‚Ä¢ Revela√ß√£o: ${teste1.revelacao}

TESTE 2 - EQUIL√çBRIO MENTAL (40 decis√µes):
‚Ä¢ O que a pessoa fez: ${teste2.resumo} 
‚Ä¢ Precis√£o: ${teste2.precisao}
‚Ä¢ Habilidade: ${teste2.habilidade}

TESTE 3 - PRESS√ÉO TEMPORAL (30 decis√µes):
‚Ä¢ O que a pessoa fez: ${teste3.resumo}
‚Ä¢ Performance: ${teste3.performance}
‚Ä¢ Adapta√ß√£o: ${teste3.adaptacao}

Crie um relat√≥rio PERSONALIZADO que gere "UAU" - destacando os padr√µes √∫nicos e talentos espec√≠ficos.`;
}

// Fun√ß√µes de an√°lise
function analisarTeste1(teste1) {
  if (!teste1?.decisions) return { resumo: 'Padr√µes em an√°lise', padrao: 'Emergente', revelacao: 'Em observa√ß√£o' };
  
  const azul = teste1.decisions.filter(d => d.choice === 'azul').length;
  const vermelho = teste1.decisions.filter(d => d.choice === 'vermelho').length;
  
  let padrao, revelacao;
  if (azul === 50) {
    padrao = '100% azul';
    revelacao = 'Comprometimento total com suas escolhas iniciais';
  } else if (vermelho === 50) {
    padrao = '100% vermelho'; 
    revelacao = 'Consist√™ncia impressionante nos primeiros impulsos';
  } else {
    padrao = 'Misturado';
    revelacao = 'Flexibilidade natural nas decis√µes r√°pidas';
  }
  
  return {
    resumo: `${azul} azuis, ${vermelho} vermelhos`,
    padrao,
    revelacao
  };
}

function analisarTeste2(teste2) {
  if (!teste2?.finalCounts) return { resumo: 'Dados em an√°lise', precisao: 'Em observa√ß√£o', habilidade: 'Em desenvolvimento' };
  
  const azul = teste2.finalCounts.azul || 0;
  const vermelho = teste2.finalCounts.vermelho || 0;
  const diff = Math.abs(azul - vermelho);
  
  let precisao, habilidade;
  if (diff === 0) {
    precisao = 'PERFEITA (50/50 exato!)';
    habilidade = 'Precis√£o absoluta em atingir objetivos';
  } else if (diff <= 2) {
    precisao = 'Excelente';
    habilidade = 'Grande capacidade de controle';
  } else {
    precisao = 'Boa com prefer√™ncias pessoais';
    habilidade = 'Autenticidade nas escolhas conscientes';
  }
  
  return {
    resumo: `${azul} azuis, ${vermelho} vermelhos`,
    precisao,
    habilidade
  };
}

function analisarTeste3(teste3) {
  if (!teste3?.pressureAnalysis) return { resumo: 'Dados em an√°lise', performance: 'Em observa√ß√£o', adaptacao: 'Em desenvolvimento' };
  
  const timeouts = teste3.pressureAnalysis.totalTimeouts || 0;
  
  let performance, adaptacao;
  if (timeouts === 0) {
    performance = 'Excelente - manteve a clareza sob press√£o';
    adaptacao = 'Alta resist√™ncia ao estresse temporal';
  } else if (timeouts <= 3) {
    performance = 'Boa - adapta√ß√£o eficiente';
    adaptacao = 'Boa capacidade de ajuste sob press√£o';
  } else {
    performance = 'Interessante - padr√µes √∫nicos sob estresse';
    adaptacao = 'Resposta aut√™ntica √† acelera√ß√£o';
  }
  
  return {
    resumo: `${timeouts} timeouts em 30 decis√µes`,
    performance,
    adaptacao
  };
}

app.get('/', (req, res) => {
  res.json({ 
    status: 'OK', 
    service: 'MindKappa Backend',
    timestamp: new Date().toISOString()
  });
});

// ==================== üí∞ CRIAR ASSINATURA ====================
// ==================== üí∞ CHECKOUT B√ÅSICO MERCADO PAGO ====================
app.post('/api/simple-subscription', async (req, res) => {
  try {
    console.log('üí∞ Criando checkout b√°sico...');
    
    // ‚úÖ CHECKOUT B√ÅSICO - m√©todo mais confi√°vel
    const preference = {
      items: [
        {
          title: 'MindKappa Premium - Acesso Mensal',
          unit_price: 0.01,
          quantity: 1,
          currency_id: 'BRL'
        }
      ],
      back_urls: {
        success: 'https://mindkappa-patterns.vercel.app/success.html',
        failure: 'https://mindkappa-patterns.vercel.app',
        pending: 'https://mindkappa-patterns.vercel.app'
      },
      auto_return: 'approved',
      statement_descriptor: 'MINDKAPPA'
    };

    console.log('üì¶ Criando prefer√™ncia...');
    const result = await mercadopago.preferences.create(preference);
    
    console.log('‚úÖ Checkout criado:', result.body.id);
    
    res.json({
      success: true,
      payment_link: result.body.init_point,
      id: result.body.id
    });

  } catch (error) {
    console.error('‚ùå Erro no checkout:', error);
    
    // ‚úÖ DETALHE DO ERRO ESPEC√çFICO
    if (error.message.includes('invalid_token')) {
      res.status(500).json({
        success: false,
        error: 'Token do Mercado Pago inv√°lido. Verifique as credenciais.'
      });
    } else {
      res.status(500).json({
        success: false,
        error: 'Erro Mercado Pago: ' + error.message
      });
    }
  }
});

// ... suas rotas atuais (health, generate-report, simple-subscription) ...

// ==================== üóÑÔ∏è BANCO DE DADOS ====================
// üîß 1. PRECISAMOS CONFIGURAR A CONEX√ÉO COM BANCO
app.get('/api/test-database', async (req, res) => {
  try {
    console.log('üß™ Testando conex√£o com banco...');
    
    // Teste simples - contar tabelas
    // TODO: Implementar teste real
    
    res.json({
      success: true,
      message: 'Conex√£o com banco OK!',
      tables: ['sessions', 'decisions', 'kappa_results']
    });
    
  } catch (error) {
    console.error('‚ùå Erro na conex√£o:', error);
    res.status(500).json({ 
      success: false, 
      error: 'Erro de conex√£o: ' + error.message 
    });
  }
});

// ==================== üß™ TESTE DE CONEX√ÉO REAL ====================
app.get('/api/test-db-connection', async (req, res) => {
  try {
    console.log('üß™ Testando conex√£o REAL com banco...');
    
    // Teste SIMPLES - contar sess√µes
    const result = await pool.query('SELECT COUNT(*) as total FROM sessions');
    const totalSessions = result.rows[0].total;
    
    res.json({
      success: true,
      message: `‚úÖ Conex√£o OK! Encontradas ${totalSessions} sess√µes`,
      database_url: process.env.DATABASE_URL ? 'Configurada' : 'N√ÉO ENCONTRADA',
      total_sessions: totalSessions
    });
    
  } catch (error) {
    console.error('‚ùå Erro na conex√£o REAL:', error);
    res.status(500).json({ 
      success: false, 
      error: 'Erro de conex√£o: ' + error.message,
      database_url: process.env.DATABASE_URL ? 'Configurada' : 'N√ÉO ENCONTRADA'
    });
  }
});

// ==================== üíæ SALVAR DADOS DE PESQUISA ====================
app.post('/api/save-research-data', async (req, res) => {
  try {
    const { userData, decisions, kappaResults } = req.body;
    
    console.log('üíæ Salvando dados de pesquisa...');
    
    // TODO: Implementar a l√≥gica de salvar nas 3 tabelas
    
    res.json({ 
      success: true, 
      message: 'Dados salvos para pesquisa!',
      sessionId: 'temp_id'
    });
    
  } catch (error) {
    console.error('‚ùå Erro ao salvar dados:', error);
    res.status(500).json({ 
      success: false, 
      error: 'Erro ao salvar dados: ' + error.message 
    });
  }
});

// ==================== üì§ EXPORTAR DADOS ====================
app.get('/api/export-research-data', async (req, res) => {
  try {
    console.log('üì§ Exportando dados de pesquisa...');
    
    // TODO: Implementar exporta√ß√£o CSV/JSON
    
    res.json({
      success: true,
      message: 'Exporta√ß√£o em desenvolvimento',
      data: []
    });
    
  } catch (error) {
    console.error('‚ùå Erro ao exportar:', error);
    res.status(500).json({ 
      success: false, 
      error: 'Erro ao exportar dados' 
    });
  }
});

// ==================== üì§ EXPORTAR DADOS CSV ====================
app.get('/api/export-csv', async (req, res) => {
  try {
    console.log('üì§ Gerando arquivo CSV...');
    
    // 1. Buscar dados das 3 tabelas
    const sessionsData = await getSessionsData();
    const kappaData = await getKappaData();
    
    // 2. Gerar CSV
    const csvContent = generateCSV(sessionsData, kappaData);
    
    // 3. Enviar como download
    res.header('Content-Type', 'text/csv');
    res.attachment('mindkappa_research_data.csv');
    res.send(csvContent);
    
    console.log('‚úÖ CSV gerado com sucesso!');
    
  } catch (error) {
    console.error('‚ùå Erro ao gerar CSV:', error);
    res.status(500).json({ 
      success: false, 
      error: 'Erro ao exportar dados: ' + error.message 
    });
  }
});

// ==================== üîç DEBUG DATABASE_URL ====================
app.get('/api/debug-db', async (req, res) => {
  const hasDbUrl = !!process.env.DATABASE_URL;
  const dbUrlPreview = process.env.DATABASE_URL 
    ? process.env.DATABASE_URL.substring(0, 50) + '...' 
    : 'N√ÉO ENCONTRADA';
  
  res.json({
    has_database_url: hasDbUrl,
    database_url_preview: dbUrlPreview,
    node_env: process.env.NODE_ENV,
    all_variables: process.env
  });
});

// ==================== üìä FUN√á√ïES AUXILIARES ====================
async function getSessionsData() {
  try {
    const result = await pool.query(`
      SELECT id, user_data, created_at, completed, is_premium 
      FROM sessions 
      ORDER BY created_at DESC
    `);
    console.log(`üìä Encontradas ${result.rows.length} sess√µes`);
    return result.rows;
  } catch (error) {
    console.error('‚ùå Erro ao buscar sess√µes:', error);
    return [];
  }
}

async function getKappaData() {
  try {
    const result = await pool.query(`
      SELECT session_id, test_1_kappa, test_2_kappa, test_3_kappa, insights, calculated_at 
      FROM kappa_results 
      ORDER BY calculated_at DESC
    `);
    console.log(`üìà Encontrados ${result.rows.length} resultados Œ∫`);
    return result.rows;
  } catch (error) {
    console.error('‚ùå Erro ao buscar resultados Œ∫:', error);
    return [];
  }
}

function generateCSV(sessions, kappaResults) {
  if (sessions.length === 0) {
    return 'session_id,age,gender,emotion,test1_kappa,test2_kappa,test3_kappa,completed,is_premium,created_at\n' +
           'NO_DATA_FOUND,,,Nenhum dado coletado ainda,,,,,\n';
  }
  
  let csv = 'session_id,age,gender,emotion,test1_kappa,test2_kappa,test3_kappa,completed,is_premium,created_at\n';
  
  sessions.forEach(session => {
    try {
      const kappa = kappaResults.find(k => k.session_id === session.id) || {};
      const user = session.user_data || {};
      
      // Extrair dados do JSONB user_data
      const age = user.age || user.idade || '';
      const gender = user.gender || user.genero || '';
      const emotion = user.emotion || user.emocao || user.emo√ß√£o || '';
      
      csv += `"${session.id}",${age},"${gender}","${emotion}",${kappa.test_1_kappa || ''},${kappa.test_2_kappa || ''},${kappa.test_3_kappa || ''},${session.completed},${session.is_premium},"${session.created_at}"\n`;
    } catch (error) {
      console.error('‚ùå Erro ao processar sess√£o:', session.id, error);
    }
  });
  
  return csv;
}

const PORT = process.env.PORT || 3001;
app.listen(PORT, '0.0.0.0', () => {
  console.log(`üöÄ MindKappa Backend rodando na porta ${PORT}`);
  console.log(`üìç Health check: http://localhost:${PORT}/health`);
});















