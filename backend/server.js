const express = require('express');
const cors = require('cors');
const { Pool } = require('pg');
const OpenAI = require('openai');
const MCDCore = require('./mcd-core');
const mercadopago = require('mercadopago');

const app = express();

// ‚úÖ CORS QUE FUNCIONA
app.use(cors({
    origin: true,
    credentials: true
}));

app.get('/healthz', (req, res) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    service: 'mindkappa-backend',
    version: '1.0.0'
  });
});

app.use(express.json());

mercadopago.configure({
  access_token: process.env.MERCADOPAGO_ACCESS_TOKEN
});

// ‚úÖ CONFIGURA√á√ïES CONTROLADAS (INTERRUPTORES)
const OPENAI_ENABLED = process.env.OPENAI_ENABLED === 'true';
const OPENAI_TIMEOUT = parseInt(process.env.OPENAI_TIMEOUT) || 10000;

console.log('üîß Configura√ß√µes Seguras:', {
    OPENAI_ENABLED,
    OPENAI_TIMEOUT
});

// ‚úÖ CONEX√ÉO COM BANCO
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: { rejectUnauthorized: false }
});

// ‚úÖ OPENAI (SE CONFIGURADO)
let openai;
if (process.env.OPENAI_API_KEY && OPENAI_ENABLED) {
    openai = new OpenAI({
        apiKey: process.env.OPENAI_API_KEY
    });
    console.log('‚úÖ OpenAI configurado (controlado)');
} else {
    console.log('üîÑ OpenAI desligado por configura√ß√£o');
}

// ‚úÖ HEALTH CHECK
app.get('/health', (req, res) => {
    res.json({ 
        status: 'OK', 
        openai_enabled: OPENAI_ENABLED,
        timestamp: new Date().toISOString()
    });
});

// ‚úÖ SALVAR DADOS (J√Å FUNCIONA)
app.post('/api/save-research-data', async (req, res) => {
    try {
        const { userData } = req.body;
        console.log('üíæ Salvando dados para:', userData?.name);
        
        const result = await pool.query(
            `INSERT INTO mindkappa_sessions1 (user_data) VALUES ($1) RETURNING id`,
            [userData]
        );

        console.log('‚úÖ Dados salvos! ID:', result.rows[0].id);
        
        res.json({ 
            success: true, 
            sessionId: result.rows[0].id
        });
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar:', error.message);
        
        res.json({ 
            success: true,
            sessionId: 'mk-' + Date.now(),
            fallback: true
        });
    }
});

// ‚úÖ NOVA ROTA: C√ÅLCULO DE COER√äNCIA COM MCD CORE
app.post('/api/calculate-coherence', async (req, res) => {
    try {
        const { choices, testType, sessionId } = req.body;
        
        console.log(`üß† Calculando coer√™ncia: ${testType}, ${choices.length} escolhas`);

        // ‚úÖ VALIDAR E CALCULAR COM MCD CORE
        MCDCore.validateChoices(choices);
        const report = MCDCore.generateReport(choices);

        // ‚úÖ SALVAR NO BANCO (OPCIONAL)
        let dbResult;
        try {
            dbResult = await pool.query(
                `INSERT INTO mindkappa_coherence (session_id, test_type, choices, kappa_value, r_value, coherence_level) 
                 VALUES ($1, $2, $3, $4, $5, $6) RETURNING id`,
                [sessionId, testType, choices, report.kappa, report.R, report.coherenceLevel]
            );
            console.log('‚úÖ Coer√™ncia salva no BD:', dbResult.rows[0].id);
        } catch (dbError) {
            console.log('üìù Coer√™ncia calculada (n√£o salva no BD):', dbError.message);
        }

        res.json({
            success: true,
            testType: testType || 'unknown',
            sessionId: sessionId || 'anonymous',
            coherence: {
                kappa: report.kappa,
                level: report.coherenceLevel,
                description: report.description,
                emoji: report.emoji,
                color: report.color
            },
            statistics: report.statistics,
            metrics: {
                R: report.R,
                N: report.N,
                timestamp: report.timestamp
            },
            savedToDb: !!dbResult
        });

    } catch (error) {
        console.error('‚ùå Erro no c√°lculo de coer√™ncia:', error);
        res.status(400).json({
            success: false,
            error: error.message,
            timestamp: new Date().toISOString()
        });
    }
});

app.post('/api/update-user-coherence', async (req, res) => {
    try {
        const { userData, sessionId } = req.body;
        console.log('üîÑ Atualizando userData com coer√™ncia...');

        const updatedUserData = JSON.parse(JSON.stringify(userData)); // deep copy

        // ‚úÖ USA SEU MCD CORE DIRETAMENTE (SEM FETCH INTERNO)
        if (userData.teste1?.decisions) {
            const choices = userData.teste1.decisions.map(d => 
                d.choice === 'azul' ? 'Azul' : 'Vermelho'
            );
            
            // ‚úÖ CHAMA MCD CORE DIRETAMENTE (igual sua rota existente)
            MCDCore.validateChoices(choices);
            const report = MCDCore.generateReport(choices);
            
            updatedUserData.teste1.coherence = {
                kappa: report.kappa,
                level: report.coherenceLevel,
                description: report.description,
                emoji: report.emoji,
                color: report.color
            };
            updatedUserData.teste1.statistics = report.statistics;
        }

        // ‚úÖ REPETE PARA teste2 E teste3
        if (userData.teste2?.decisions) {
            const choices = userData.teste2.decisions.map(d => 
                d.choice === 'azul' ? 'Azul' : 'Vermelho'
            );
            
            MCDCore.validateChoices(choices);
            const report = MCDCore.generateReport(choices);
            
            updatedUserData.teste2.coherence = {
                kappa: report.kappa,
                level: report.coherenceLevel,
                description: report.description, 
                emoji: report.emoji,
                color: report.color
            };
            updatedUserData.teste2.statistics = report.statistics;
        }

        if (userData.teste3?.decisions) {
            const choices = userData.teste3.decisions.map(d => 
                d.choice === 'azul' ? 'Azul' : 'Vermelho'
            );
            
            MCDCore.validateChoices(choices);
            const report = MCDCore.generateReport(choices);
            
            updatedUserData.teste3.coherence = {
                kappa: report.kappa,
                level: report.coherenceLevel,
                description: report.description,
                emoji: report.emoji, 
                color: report.color
            };
            updatedUserData.teste3.statistics = report.statistics;
        }

        res.json({
            success: true,
            updatedUserData: updatedUserData
        });

    } catch (error) {
        console.error('‚ùå Erro ao atualizar coer√™ncia:', error);
        res.status(500).json({
            success: false,
            error: error.message
        });
    }
});

// ‚úÖ RELAT√ìRIO PREMIUM - √âTICO E AVAN√áADO
app.post('/api/generate-premium-report', async (req, res) => {
    try {
        const { userData, sessionId } = req.body;
        console.log('üíé Gerando relat√≥rio premium para:', userData?.name);
        
        // ‚úÖ NOVO: LOG DOS DADOS RECEBIDOS
        console.log('üîç Dados recebidos para an√°lise premium:', {
            temTeste1: !!userData.teste1,
            temTeste2: !!userData.teste2,
            temTeste3: !!userData.teste3,
            coerenciaTeste1: userData.teste1?.coherence,
            coerenciaTeste2: userData.teste2?.coherence,
            coerenciaTeste3: userData.teste3?.coherence
        });

        let relatorioPremium, source;

        // ‚úÖ INTERRUPTOR: OPENAI LIGADO/DESLIGADO
        if (OPENAI_ENABLED && openai) {
            console.log('üîÑ Gerando an√°lise premium com GPT-3.5-turbo...');
            
            try {
                const completion = await Promise.race([
                    openai.chat.completions.create({
                        model: "gpt-3.5-turbo", // ‚úÖ FOCO NO QUE FUNCIONA
                        messages: [{
                            role: "user",
                            content: gerarPromptPremium(userData)
                        }],
                        max_tokens: 1500, // ‚úÖ AUMENTEI PARA MAIS DETALHES
                        temperature: 0.8 // ‚úÖ MAIS CRIATIVIDADE
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout ap√≥s 30s')), 30000)
                    )
                ]);

                console.log('‚úÖ GPT-3.5-turbo SUCESSO! Relat√≥rio premium gerado.');
                relatorioPremium = completion.choices[0].message.content;
                source = 'gpt35_premium';
                
            } catch (error) {
                console.log('‚ùå GPT-3.5 falhou:', error.message);
                relatorioPremium = gerarFallbackPremium(userData);
                source = 'fallback_premium';
            }
        }        

        // ‚úÖ LOG DO TIPO DE RELAT√ìRIO GERADO
        console.log(`üìÑ Relat√≥rio premium gerado via: ${source}`);
        console.log(`üìè Tamanho do relat√≥rio: ${relatorioPremium?.length} caracteres`);

        // ‚úÖ SALVAR NO BANCO (OPCIONAL)
        let dbResult;
        try {
            dbResult = await pool.query(
                `INSERT INTO mindkappa_premium_reports (session_id, user_name, report_content, generated_at) 
                 VALUES ($1, $2, $3, $4) RETURNING id`,
                [sessionId, userData?.name, relatorioPremium, new Date().toISOString()]
            );
            console.log('üíæ Relat√≥rio premium salvo no BD:', dbResult.rows[0].id);
        } catch (dbError) {
            console.log('üìù Relat√≥rio premium n√£o salvo no BD:', dbError.message);
        }

        res.json({ 
            success: true,
            relatorio: relatorioPremium,
            source: source,
            tipo: 'premium'
        });

    } catch (error) {
        console.error('‚ùå Erro cr√≠tico no relat√≥rio premium:', error);
        res.status(500).json({
            success: false,
            error: 'Erro ao gerar relat√≥rio premium'
        });
    }
});

function gerarPromptGratuito(userData) {
    // ‚úÖ EXTRAIR DADOS REAIS DOS TESTES
    const t1 = userData.teste1;
    const t2 = userData.teste2; 
    const t3 = userData.teste3;

    const nome = userData.name || 'Explorador';
    
    // ‚úÖ CALCULAR ESTAT√çSTICAS REAIS
    const azuis1 = t1?.statistics?.blueCount || 0;
    const vermelhos1 = t1?.statistics?.redCount || 0;
    
    const azuis2 = t2?.statistics?.blueCount || 0;
    const vermelhos2 = t2?.statistics?.redCount || 0;
    
    const azuis3 = t3?.statistics?.blueCount || 0;
    const vermelhos3 = t3?.statistics?.redCount || 0;

    return `
CRIE UM RELAT√ìRIO EXCLUSIVO DO MINDKAPPA USANDO ESTA ESTRUTURA EXATA:

üß† SEU RELAT√ìRIO PESSOAL DO MCD
${nome} - Descobrindo Como Sua Mente Funciona

üéØ O QUE VOC√ä FEZ (RESUMO SIMPLES)
Voc√™ participou de 3 testes diferentes onde tinha que escolher entre AZUL e VERMELHO.

TESTE 1: "Instinto Puro - Primeira Rea√ß√£o"
‚Ä¢ O que pedimos: Siga sua primeira intui√ß√£o
‚Ä¢ O que voc√™ fez: ${azuis1} azuis e ${vermelhos1} vermelhos
‚Ä¢ O que isso revela: ${gerarInsightTeste1(azuis1, vermelhos1)}

TESTE 2: "Equil√≠brio Mental - Busque Balanceamento"  
‚Ä¢ O que pedimos: Tente equilibrar suas escolhas
‚Ä¢ O que voc√™ fez: ${azuis2} azuis e ${vermelhos2} vermelhos
‚Ä¢ O que isso revela: ${gerarInsightTeste2(azuis2, vermelhos2)}

TESTE 3: "Press√£o Temporal - Decis√µes R√°pidas"
‚Ä¢ O que pedimos: Escolha sob press√£o de tempo
‚Ä¢ O que voc√™ fez: ${azuis3} azuis e ${vermelhos3} vermelhos  
‚Ä¢ O que isso revela: ${gerarInsightTeste3(azuis3, vermelhos3)}

üîç O QUE DESCOBRIMOS SOBRE VOC√ä
${gerarPerfilMental(nome, azuis1, vermelhos1, azuis2, vermelhos2, azuis3, vermelhos3)}

üí° DICAS PARA SEU DIA A DIA
${gerarDicasPraticas(azuis1, vermelhos1, azuis2, vermelhos2, azuis3, vermelhos3)}

üéâ MENSAGEM FINAL
${gerarMensagemFinal(nome)}

---
INSTRU√á√ïES OBRIGAT√ìRIAS:
‚Ä¢ USE APENAS "AZUL" e "VERMELHO" (nunca A/B ou outras cores)
‚Ä¢ USE "MCD" ou "MindKappa" (nunca ABC ou outros nomes)
‚Ä¢ SIGA A ESTRUTURA ACIMA EXATAMENTE
‚Ä¢ LINGUAGEM: Conversacional, motivadora, espec√≠fica
‚Ä¢ CHAME O USU√ÅRIO PELO NOME: "${nome}, sua mente..."
`;
}

function gerarDicasPraticas(azuis1, vermelhos1, azuis2, vermelhos2, azuis3, vermelhos3) {
    const dicas = [];
    
    if (azuis1 === 0 || vermelhos1 === 0) {
        dicas.push("‚Ä¢ CONFIE NA SUA INTUI√á√ÉO - Quando voc√™ segue seu instinto, age com convic√ß√£o!");
    }
    
    if (Math.abs(azuis2 - vermelhos2) <= 2) {
        dicas.push("‚Ä¢ USE SEU TALENTO PARA EQUIL√çBRIO - Voc√™ √© √≥timo em encontrar meio-termo em discuss√µes!");
    }
    
    if (azuis3 === 0 || vermelhos3 === 0) {
        dicas.push("‚Ä¢ EM MOMENTOS DECISIVOS - Lembre-se que voc√™ fica super focado sob press√£o, use isso a seu favor!");
    }
    
    if (dicas.length === 0) {
        dicas.push("‚Ä¢ EXPERIMENTE DIFERENTES ABORDAGENS - Sua mente se adapta bem a diversos contextos!");
        dicas.push("‚Ä¢ OBSERVE SEUS PADR√ïES - Preste aten√ß√£o em como voc√™ toma decis√µes no dia a dia!");
    }
    
    return dicas.join('\n');
}

function gerarMensagemFinal(nome) {
    const mensagens = [
        `${nome}, sua mente √© √∫nica e especial! Os padr√µes que descobrimos mostram caracter√≠sticas valiosas que voc√™ pode usar a seu favor!`,
        `${nome}, o teste revelou talentos mentais incr√≠veis! Continue explorando como sua mente funciona - o autoconhecimento √© um superpoder!`,
        `${nome}, cada mente √© uma obra de arte! A sua tem padr√µes fascinantes que merecem ser celebrados e usados com sabedoria!`
    ];
    
    return mensagens[Math.floor(Math.random() * mensagens.length)];
}

// ‚úÖ FUN√á√ïES DE INSIGHT ESPEC√çFICAS
function gerarInsightTeste1(azuis, vermelhos) {
    const total = azuis + vermelhos;
    if (total === 0) return "Seu instinto est√° sendo analisado...";
    
    if (azuis === 0 || vermelhos === 0) {
        return "Quando voc√™ segue a intui√ß√£o, vai at√© o fim sem hesitar! Sua mente escolhe um caminho e segue com convic√ß√£o total!";
    }
    if (Math.abs(azuis - vermelhos) <= 2) {
        return "Seu instinto naturalmente busca equil√≠brio! Sua primeira rea√ß√£o j√° considera diferentes perspectivas de forma harmoniosa!";
    }
    if (azuis > vermelhos * 1.5) {
        return "Sua intui√ß√£o tem uma clara prefer√™ncia pelo azul! Quando voc√™ n√£o pensa muito, sua mente escolhe uma dire√ß√£o espec√≠fica!";
    }
    if (vermelhos > azuis * 1.5) {
        return "Sua intui√ß√£o tem uma clara prefer√™ncia pelo vermelho! Sua mente instintiva sabe exatamente o que quer!";
    }
    return "Sua primeira rea√ß√£o tem prefer√™ncias bem definidas, mas com espa√ßo para varia√ß√£o!";
}

function gerarInsightTeste2(azuis, vermelhos) {
    const total = azuis + vermelhos;
    if (total === 0) return "Seu equil√≠brio est√° sendo analisado...";
    
    const diferenca = Math.abs(azuis - vermelhos);
    
    if (diferenca === 0) {
        return "PERFEITO! Quando voc√™ tenta equilibrar, consegue com precis√£o absoluta! Sua mente √© uma balan√ßa perfeita!";
    }
    if (diferenca <= 2) {
        return "Excelente! Voc√™ tem um talento natural para encontrar equil√≠brio! Sua mente busca harmonia de forma consistente!";
    }
    if (diferenca <= 5) {
        return "Voc√™ se esfor√ßa pelo equil√≠brio, mas suas prefer√™ncias pessoais ainda aparecem! Isso mostra autenticidade!";
    }
    return "Mesmo tentando equilibrar, suas inclina√ß√µes naturais s√£o fortes! Isso revela personalidade bem definida!";
}

function gerarInsightTeste3(azuis, vermelhos) {
    const total = azuis + vermelhos;
    if (total === 0) return "Sua performance sob press√£o est√° sendo analisada...";
    
    if (azuis === 0 || vermelhos === 0) {
        return "SOB PRESS√ÉO, voc√™ se torna super focado! Sua mente escolhe uma dire√ß√£o e segue com determina√ß√£o total, sem distra√ß√µes!";
    }
    if (Math.abs(azuis - vermelhos) <= 3) {
        return "Inc√≠vel! Mesmo sob press√£o, voc√™ mant√©m o equil√≠brio! Sua mente funciona bem mesmo em situa√ß√µes desafiadoras!";
    }
    if (azuis > vermelhos) {
        return "Sob press√£o, sua mente se inclina fortemente para o azul! O estresse traz √† tona suas prefer√™ncias mais profundas!";
    }
    return "Sob press√£o, sua mente se inclina fortemente para o vermelho! Situa√ß√µes intensas revelam seu lado mais decisivo!";
}

function gerarPerfilMental(nome, azuis1, vermelhos1, azuis2, vermelhos2, azuis3, vermelhos3) {
    const perfis = [];
    
    // ‚úÖ ANALISAR MUDAN√áA ENTRE TESTE 1 E 2
    const preferencia1 = azuis1 > vermelhos1 ? "AZUL" : "VERMELHO";
    const preferencia2 = azuis2 > vermelhos2 ? "AZUL" : "VERMELHO";
    
    if (preferencia1 !== preferencia2) {
        perfis.push(`MENTE ADAPT√ÅVEL - Voc√™ muda de estrat√©gia quando o contexto pede (de ${preferencia1} para ${preferencia2})`);
    }
    
    // ‚úÖ ANALISAR FOR√áA DAS PREFER√äNCIAS
    const diferenca1 = Math.abs(azuis1 - vermelhos1);
    const diferenca2 = Math.abs(azuis2 - vermelhos2);
    
    if (diferenca1 >= 7) {
        perfis.push("INTUI√á√ÉO FORTE - Seu instinto tem prefer√™ncias bem definidas");
    }
    
    if (diferenca2 >= 8) {
        perfis.push("PERSONALIDADE MARCADA - Mesmo tentando equilibrar, seu estilo √∫nico aparece");
    }
    
    // ‚úÖ ANALISAR CONSIST√äNCIA SOB PRESS√ÉO
    const preferencia3 = azuis3 > vermelhos3 ? "AZUL" : "VERMELHO";
    if (preferencia2 === preferencia3) {
        perfis.push("FOCO SOB PRESS√ÉO - Sob estresse, voc√™ mant√©m a mesma dire√ß√£o que escolheu conscientemente");
    }
    
    if (perfis.length === 0) {
        perfis.push("EXPLORADOR √öNICO - Sua mente tem combina√ß√µes especiais que merecem ser descobertas");
    }
    
    return `${nome}, descobrimos que sua mente √© fascinante! \n\nSEU PERFIL: "${perfis[0]}"\n\nCOMO SUA MENTE FUNCIONA:\n‚Ä¢ ${perfis.join('\n‚Ä¢ ')}\n\nIsso revela padr√µes mentais muito interessantes!`;
}

// ‚úÖ RELAT√ìRIO SEGURO COM INTERRUPTOR
app.post('/api/generate-report', async (req, res) => {
    try {
        const { userData } = req.body;
        console.log('üß† Gerando relat√≥rio para:', userData?.name);

        let relatorio, source;

        // ‚úÖ INTERRUPTOR: OPENAI LIGADO/DESLIGADO
        if (OPENAI_ENABLED && openai) {
            console.log('üîÑ Tentando OpenAI...');
            
            try {
                const completion = await Promise.race([
                    openai.chat.completions.create({
                        model: "gpt-3.5-turbo",
                        messages: [{
                            role: "user",
                            content: gerarPromptGratuito(userData)
}],
                        max_tokens: 600,
                        temperature: 0.7
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), OPENAI_TIMEOUT)
                    )
                ]);

                relatorio = completion.choices[0].message.content;
                source = 'openai';
                console.log('‚úÖ OpenAI funcionou!');
                
            } catch (openaiError) {
                console.log('üîÑ OpenAI falhou, usando fallback:', openaiError.message);
            }
        }

        // ‚úÖ FALLBACK GARANTIDO (sempre funciona)
        if (!relatorio) {
            relatorio = `Relat√≥rio personalizado para ${userData?.name}. Seus 3 testes de padr√µes mentais foram analisados com sucesso! Padr√µes √∫nicos detectados.`;
            source = 'fallback';
        }

        res.json({ 
            success: true,
            relatorio: relatorio,
            source: source
        });

    } catch (error) {
        console.error('‚ùå Erro geral:', error);
        
        res.json({
            success: true,
            relatorio: 'An√°lise conclu√≠da. Seus dados foram processados com sucesso!',
            source: 'emergency_fallback'
        });
    }
});

// ‚úÖ MERCADO PAGO (J√Å FUNCIONA)
app.post('/api/simple-subscription', async (req, res) => {
  try {
    console.log('üîÑ Criando pagamento com PIX...');
    
    const preference = {
      items: [
        {
          title: 'Relat√≥rio Premium MindKappa',
          unit_price: 9.90,
          quantity: 1,
          currency_id: 'BRL',
          description: 'An√°lise profunda do seu padr√£o decisional com relat√≥rio PDF completo'
        }
      ],
      back_urls: {
        success: `${process.env.FRONTEND_URL}/success.html`,
        failure: `${process.env.FRONTEND_URL}/failure.html`,
        pending: `${process.env.FRONTEND_URL}/pending.html`
      },
      auto_return: 'approved',
      statement_descriptor: 'MINDKAPPA',
      
      // ‚úÖ NOVO: CONFIGURA√á√ÉO PIX
      payment_methods: {
        excluded_payment_types: [
          { id: 'ticket' }, // Remove boleto
          { id: 'atm' }     // Remove caixa eletr√¥nico
        ],
        default_installments: 1,
        excluded_payment_methods: [
          { id: 'debvisa' }, // Remove d√©bito
          { id: 'debmaster' }
        ]
      },
      
      // ‚úÖ PIX AUTOM√ÅTICO (30 minutos)
      pix: {
        expiration: 1800 // 30 minutos em segundos
      }
    };


       const response = await mercadopago.preferences.create(preference);
    
    console.log('‚úÖ Pagamento PIX criado:', response.body.id);
    
    res.json({
      success: true,
      payment_link: response.body.init_point,
      fallback: false,
      // ‚úÖ NOVO: DADOS PIX ESPEC√çFICOS
      pix_data: response.body.pix || null
    });

  } catch (error) {
    console.error('‚ùå Erro Mercado Pago:', error);
    res.status(500).json({
      success: false,
      error: 'Erro ao criar pagamento',
      fallback: true
    });
  }
});

function gerarPromptPremium(userData) {
    const t1 = userData.teste1;
    const t2 = userData.teste2;
    const t3 = userData.teste3;

    const nome = userData.name || 'Explorador';
    
    const azuis1 = t1?.statistics?.blueCount || 0;
    const vermelhos1 = t1?.statistics?.redCount || 0;
    const azuis2 = t2?.statistics?.blueCount || 0;
    const vermelhos2 = t2?.statistics?.redCount || 0;
    const azuis3 = t3?.statistics?.blueCount || 0;
    const vermelhos3 = t3?.statistics?.redCount || 0;

    const k1 = t1?.coherence?.kappa || 0;
    const k2 = t2?.coherence?.kappa || 0;
    const k3 = t3?.coherence?.kappa || 0;

    return `
CRIE UM RELAT√ìRIO PREMIUM **IMPRESSIOANTE** PARA ESTUDIOSOS DE COMPORTAMENTO:

DADOS COMPLETOS DO USU√ÅRIO:
‚Ä¢ NOME: ${nome}
‚Ä¢ TESTE 1 (Instinto): ${azuis1} azuis, ${vermelhos1} vermelhos | Œ∫ = ${k1.toFixed(3)}
‚Ä¢ TESTE 2 (Equil√≠brio): ${azuis2} azuis, ${vermelhos2} vermelhos | Œ∫ = ${k2.toFixed(3)}  
‚Ä¢ TESTE 3 (Press√£o): ${azuis3} azuis, ${vermelhos3} vermelhos | Œ∫ = ${k3.toFixed(3)}

INSTRU√á√ïES PARA RELAT√ìRIO **IMPRESSIOANTE**:

üß† AN√ÅLISE PROFUNDA DO PERFIL COGNITIVO
[Incluir an√°lise t√©cnica dos padr√µes Œ∫]

üìä MAPA VISUAL DE PADR√ïES  
[Descrever visualmente os 3 testes lado a lado]

üéØ DETEC√á√ÉO DE TEND√äNCIAS COMPORTAMENTAIS
[Identificar padr√µes espec√≠ficos: criatividade vs foco, Œ∫ alto vs baixo]

üí° EXERC√çCIOS COMPORTAMENTAIS PERSONALIZADOS
[Criar 3-4 exerc√≠cios baseados nos padr√µes detectados]

üî¨ BENCHMARK CIENT√çFICO
[Comparar com bases de pesquisa em tomada de decis√£o]

üìà ESTRAT√âGIAS DE OTIMIZA√á√ÉO COGNITIVA
[Baseado em Œ∫ alto/baixo para diferentes contexts]

ESTRUTURA OBRIGAT√ìTIA:
1. An√°lise T√©cnica Profunda
2. Padr√µes Detectados com Dados
3. Exerc√≠cios Pr√°ticos Personalizados  
4. Contexto Cient√≠fico
5. Estrat√©gias de Alto Impacto

N√çVEL: Estudosos de comportamento - linguagem t√©cnica mas acess√≠vel
TAMANHO: Extremamente detalhado (m√°ximo de tokens)
`;
}

// ‚úÖ FUN√á√ÉO FALLBACK PREMIUM
function gerarFallbackPremium(userData) {
    const t1 = userData.teste1;
    const t2 = userData.teste2;
    const t3 = userData.teste3;

    const nome = userData.name || 'Explorador';
    
    const azuis1 = t1?.statistics?.blueCount || 0;
    const vermelhos1 = t1?.statistics?.redCount || 0;
    const azuis2 = t2?.statistics?.blueCount || 0;
    const vermelhos2 = t2?.statistics?.redCount || 0;
    const azuis3 = t3?.statistics?.blueCount || 0;
    const vermelhos3 = t3?.statistics?.redCount || 0;
    
    return `üß† RELAT√ìRIO PREMIUM MINDKAPPA - ${nome}

üìä AN√ÅLISE AVAN√áADA DOS SEUS PADR√ïES DECISIONAIS

Seus dados de ${azuis1 + vermelhos1 + azuis2 + vermelhos2 + azuis3 + vermelhos3} escolhas revelam padr√µes fascinantes de comportamento decisional em diferentes contextos.

üìà SEUS RESULTADOS:
‚Ä¢ INSTINTO: ${azuis1} azuis, ${vermelhos1} vermelhos
‚Ä¢ EQUIL√çBRIO: ${azuis2} azuis, ${vermelhos2} vermelhos
‚Ä¢ PRESS√ÉO: ${azuis3} azuis, ${vermelhos3} vermelhos

üí° PADR√ïES IDENTIFICADOS:
Sua mente mostra caracter√≠sticas √∫nicas de adapta√ß√£o e consist√™ncia entre os diferentes contextos testados.

üéØ PR√ìXIMOS PASSOS:
Para uma an√°lise completa com IA avan√ßada, tente novamente em alguns minutos.

---
üõ°Ô∏è AVISO: Este √© um relat√≥rio educacional de autoconhecimento.
N√£o constitui avalia√ß√£o psicol√≥gica ou m√©dica.

MindKappa - Tecnologia para Autoconhecimento üß†`;
}

const PORT = process.env.PORT || 3001;

app.listen(PORT, '0.0.0.0', () => {
    console.log(`üöÄ MindKappa Backend SEGURO rodando na porta ${PORT}`);
    console.log(`üß† MCD Core: ATIVO`);
    console.log(`üí≥ Mercado Pago: ${process.env.MERCADOPAGO_ACCESS_TOKEN ? 'PRONTO PARA PAGAMENTOS' : 'CONFIGURAR'}`);
    console.log(`ü§ñ OpenAI: ${OPENAI_ENABLED ? 'LIGADO' : 'DESLIGADO'}`);
    console.log(`üîó Frontend: ${process.env.FRONTEND_URL || 'N√ÉO CONFIGURADO'}`);
    console.log(`üìä Health: http://localhost:${PORT}/health`);
});

// ‚úÖ MANTER PROCESSO ATIVO (OPCIONAL MAS RECOMENDADO)
process.on('SIGTERM', () => {
    console.log('üîÑ Servidor recebeu SIGTERM, encerrando graciosamente...');
    process.exit(0);
});

process.on('SIGINT', () => {
    console.log('üîÑ Servidor reiniciando...');
    process.exit(0);
});

